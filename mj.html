<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midjourney V7 Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 深色极客风 */
        body { background-color: #0f172a; color: #e2e8f0; }
        
        /* 滚动条 */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
        
        .loader {
            width: 18px; height: 18px;
            border: 2px solid #fff; border-bottom-color: transparent;
            border-radius: 50%; display: inline-block;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 比例按钮激活态 */
        .ratio-btn.active {
            background-color: #6366f1; /* Indigo-500 */
            border-color: #6366f1;
            color: white;
        }
    </style>
</head>
<body class="min-h-screen md:h-screen flex flex-col md:flex-row font-sans md:overflow-hidden selection:bg-indigo-500 selection:text-white">

    <!-- 左侧控制台 -->
    <div class="w-full md:w-[400px] bg-slate-900 border-r border-slate-800 flex flex-col z-20 shadow-2xl h-full order-2 md:order-1 relative">
        
        <!-- 顶部导航 -->
        <div class="p-5 border-b border-slate-800 sticky top-0 bg-slate-900 z-10 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-white tracking-tight flex items-center gap-2">
                    Midjourney
                    <span class="text-[10px] bg-indigo-500/20 text-indigo-300 px-1.5 py-0.5 rounded border border-indigo-500/30">V7</span>
                </h1>
                <p class="text-xs text-slate-400 mt-1">公测中: 每日限量 10 张</p>
            </div>
            <!-- 返回 NAI 按钮 -->
            <a href="/" class="text-xs px-3 py-1.5 rounded bg-slate-800 hover:bg-slate-700 text-slate-300 transition-colors flex items-center gap-1 border border-slate-700">
                <i data-lucide="arrow-left" class="w-3 h-3"></i> 返回 NAI
            </a>
        </div>

        <!-- 参数设置区 -->
        <div class="flex-1 overflow-y-auto p-5 space-y-6">
            
            <!-- 提示词 -->
            <div class="space-y-2">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">提示词 (Prompt)</label>
                <textarea id="prompt" rows="6" class="w-full bg-slate-800 border border-slate-700 text-white text-sm rounded-lg focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 block p-3 resize-none outline-none transition-all placeholder-slate-600" placeholder="例如: A cute cat sitting on a spaceship, cyberpunk style, cinematic lighting..."></textarea>
            </div>

            <!-- 比例选择 -->
            <div class="space-y-2">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">画幅比例 (--ar)</label>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="setRatio('1:1')" class="ratio-btn active p-2 rounded border border-slate-700 bg-slate-800 text-xs text-slate-300 hover:border-slate-600 transition-all">1:1</button>
                    <button onclick="setRatio('16:9')" class="ratio-btn p-2 rounded border border-slate-700 bg-slate-800 text-xs text-slate-300 hover:border-slate-600 transition-all">16:9</button>
                    <button onclick="setRatio('9:16')" class="ratio-btn p-2 rounded border border-slate-700 bg-slate-800 text-xs text-slate-300 hover:border-slate-600 transition-all">9:16</button>
                    <button onclick="setRatio('3:4')" class="ratio-btn p-2 rounded border border-slate-700 bg-slate-800 text-xs text-slate-300 hover:border-slate-600 transition-all">3:4</button>
                </div>
            </div>

            <!-- 模型选择 (已更新 V7) -->
            <div class="space-y-2">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">模型版本</label>
                <div class="relative">
                    <select id="model" class="w-full bg-slate-800 border border-slate-700 text-white text-sm rounded-lg p-2.5 outline-none focus:border-indigo-500 appearance-none cursor-pointer">
                        <option value="--v 7">Midjourney V7 (最新)</option>
                        <option value="--niji 6">Niji V6 (二次元/动漫)</option>
                        <option value="--v 6.1">Midjourney V6.1 (稳定)</option>
                        <option value="--v 6.0">Midjourney V6.0 (旧版)</option>
                    </select>
                    <i data-lucide="chevron-down" class="absolute right-3 top-3 w-4 h-4 text-slate-500 pointer-events-none"></i>
                </div>
            </div>
        </div>

        <!-- 底部按钮 -->
        <div class="p-5 border-t border-slate-800 bg-slate-900 sticky bottom-0 z-20">
            <button id="generateBtn" class="w-full flex items-center justify-center gap-2 py-3.5 px-4 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold rounded-lg transition-all shadow-lg shadow-indigo-900/20 active:scale-[0.98]">
                <span id="btnIcon"><i data-lucide="sparkles" class="w-4 h-4"></i></span>
                <span id="btnLoader" class="hidden"><span class="loader"></span></span>
                <span id="btnText">生成图片 (消耗额度)</span>
            </button>
            <div id="statusText" class="text-center text-[10px] text-slate-500 mt-2 h-4 font-mono"></div>
        </div>
    </div>

    <!-- 右侧预览区 -->
    <div class="flex-1 relative flex flex-col h-[45vh] md:h-full bg-slate-950 overflow-hidden order-1 md:order-2">
        <div class="flex-1 flex items-center justify-center p-4 md:p-10 relative">
            
            <!-- 空状态 -->
            <div id="placeholder" class="text-center transition-opacity duration-300">
                <div class="w-20 h-20 bg-slate-900 rounded-2xl flex items-center justify-center mx-auto mb-4 border border-slate-800 shadow-xl">
                    <i data-lucide="image" class="w-8 h-8 text-slate-700"></i>
                </div>
                <p class="text-slate-500 text-sm">配置参数并点击生成</p>
                <div class="mt-4 flex justify-center gap-4 text-[10px] text-slate-600">
                    <span onclick="enterAdminToken()" class="cursor-pointer hover:text-indigo-400">我是管理员</span>
                </div>
            </div>
            
            <!-- 结果图片 -->
            <img id="resultImage" class="hidden max-w-full max-h-full object-contain shadow-2xl rounded-lg border border-slate-800">
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        // 状态变量
        let currentRatio = '1:1';
        let isGenerating = false;

        // 设置比例
        function setRatio(r) {
            currentRatio = r;
            document.querySelectorAll('.ratio-btn').forEach(b => {
                b.classList.remove('active');
                if(b.innerText === r) b.classList.add('active');
            });
        }

        // 管理员登录 (共享 NAI 的 Key)
        function enterAdminToken() {
            const t = prompt("输入管理员密码 (Admin Token):");
            if(t) { 
                localStorage.setItem('nai_admin_token', t.trim()); 
                alert("密码已保存，您现在拥有无限额度。"); 
            }
        }

        const els = {
            btn: document.getElementById('generateBtn'),
            btnText: document.getElementById('btnText'),
            btnIcon: document.getElementById('btnIcon'),
            loader: document.getElementById('btnLoader'),
            img: document.getElementById('resultImage'),
            holder: document.getElementById('placeholder'),
            status: document.getElementById('statusText')
        };

        function setStatus(msg, type='normal') {
            els.status.textContent = msg;
            els.status.className = `text-center text-[10px] mt-2 h-4 font-mono ${type === 'error' ? 'text-red-400' : 'text-slate-500'}`;
        }

        function setLoading(b) {
            isGenerating = b;
            els.btn.disabled = b;
            if(b) {
                els.btnText.textContent = "任务排队中...";
                els.btnIcon.classList.add('hidden');
                els.loader.classList.remove('hidden');
            } else {
                els.btnText.textContent = "生成图片 (消耗额度)";
                els.btnIcon.classList.remove('hidden');
                els.loader.classList.add('hidden');
            }
        }

        els.btn.addEventListener('click', async () => {
            if(isGenerating) return;

            const rawPrompt = document.getElementById('prompt').value.trim();
            if(!rawPrompt) {
                alert("请输入提示词");
                document.getElementById('prompt').focus();
                return;
            }

            const modelParam = document.getElementById('model').value;
            // 拼接最终 Prompt
            // 逻辑: "提示词 --ar 1:1 --v 7"
            const finalPrompt = `${rawPrompt} --ar ${currentRatio} ${modelParam}`;

            setLoading(true);
            setStatus("正在提交任务...");

            try {
                const adminToken = localStorage.getItem('nai_admin_token') || "";
                
                // 1. 提交任务 (Imagine)
                const submitRes = await fetch('/mj', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-token': adminToken },
                    body: JSON.stringify({ action: 'imagine', prompt: finalPrompt })
                });

                const submitData = await submitRes.json();
                
                if(!submitRes.ok) {
                    if(submitRes.status === 429) {
                        throw new Error("今日额度耗尽 (请联系管理员或明日再试)");
                    }
                    if(submitRes.status === 403) {
                        throw new Error("功能未开放 (系统维护中)");
                    }
                    throw new Error(submitData.error || "提交失败");
                }
                
                // 获取 Task ID
                const taskId = submitData.result; 
                if(!taskId) throw new Error("API未返回任务ID");

                setStatus(`任务ID: ${taskId} | 正在绘制...`);

                // 2. 轮询进度 (Fetch)
                let isFinished = false;
                let retryCount = 0;
                const maxRetries = 60; 

                while(!isFinished && retryCount < maxRetries) {
                    await new Promise(r => setTimeout(r, 3000));
                    
                    const checkRes = await fetch('/mj', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'x-admin-token': adminToken },
                        body: JSON.stringify({ action: 'fetch', taskId: taskId })
                    });
                    
                    if(!checkRes.ok) continue;
                    
                    const checkData = await checkRes.json();
                    
                    if(checkData.status === 'SUCCESS') {
                        els.img.src = checkData.imageUrl;
                        els.img.onload = () => {
                            els.img.classList.remove('hidden');
                            els.holder.classList.add('hidden');
                        };
                        isFinished = true;
                        setStatus("绘制完成！");
                    } else if (checkData.status === 'FAILURE') {
                        throw new Error(checkData.failReason || "MJ 绘图失败");
                    } else {
                        const progress = checkData.progress || '...';
                        setStatus(`绘制中... ${progress}`);
                    }
                    retryCount++;
                }

                if(!isFinished) throw new Error("任务超时，请稍后在后台查看");

            } catch (e) {
                console.error(e);
                setStatus(e.message, 'error');
                alert(e.message);
            } finally {
                setLoading(false);
            }
        });
    </script>
</body>
</html>