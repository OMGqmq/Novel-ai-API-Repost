<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NovelAI Opus Art</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // å®šä¹‰è‰ºæœ¯ç°ç™½åº¦
                        art: {
                            bg: '#f9fafb',
                            surface: '#ffffff',
                            border: '#e5e7eb',
                            text: '#374151',
                            accent: '#111827'
                        },
                        dark: {
                            bg: '#0f172a',
                            surface: '#1e293b',
                            border: '#334155',
                            text: '#cbd5e1',
                            accent: '#f8fafc'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'art': '0 4px 20px -2px rgba(0, 0, 0, 0.05), 0 0 0 1px rgba(0,0,0,0.02)',
                        'float': '0 20px 40px -5px rgba(0, 0, 0, 0.1), 0 10px 20px -5px rgba(0, 0, 0, 0.04), 0 0 0 1px rgba(255,255,255,0.5) inset'
                    },
                    height: { 'screen-dvh': '100dvh' }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        /* å…¨å±€èƒŒæ™¯ï¼šæµåŠ¨çš„ç°ç™½å…‰å½± */
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(255,255,255,0.8) 0%, transparent 40%),
                radial-gradient(circle at 100% 100%, #f1f5f9 0%, transparent 40%),
                linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            background-attachment: fixed;
            color: #374151;
            overscroll-behavior: none;
        }
        
        html.dark body {
            background-color: #0f172a;
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(30, 41, 59, 0.5) 0%, transparent 40%),
                linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #cbd5e1;
        }

        /* éšè—æ»šåŠ¨æ¡ */
        .custom-scroll::-webkit-scrollbar { width: 0px; background: transparent; }

        /* ç»ç’ƒæ‹Ÿæ€é¢æ¿ï¼šå¼ºè°ƒçº¿æ¡æ„Ÿ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.03);
        }
        html.dark .glass-panel {
            background: rgba(30, 41, 59, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }

        /* è¾“å…¥æ¡†çº¿æ¡ç¾å­¦ */
        .art-input {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #e5e7eb;
            background: rgba(255,255,255,0.6);
        }
        .art-input:focus, .art-input:hover {
            border-color: #9ca3af;
            background: #ffffff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }
        html.dark .art-input {
            border-color: #334155;
            background: rgba(30, 41, 59, 0.6);
        }
        html.dark .art-input:focus, html.dark .art-input:hover {
            border-color: #64748b;
            background: #1e293b;
        }

        /* ç§»åŠ¨ç«¯åº•éƒ¨æŠ½å±‰ */
        #mobileControls {
            transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1); /* æ›´ä¼˜é›…çš„ç¼“åŠ¨ */
            will-change: transform;
        }
        #mobileControls.collapsed { transform: translateY(calc(100% - 64px)); } /* åªéœ²å‡ºä¸€è¡Œæ ‡é¢˜æ  */
        #mobileControls.expanded { transform: translateY(0); }

        /* é®ç½©å±‚ */
        #mobileBackdrop { transition: opacity 0.4s ease; }
        #mobileBackdrop.hidden-backdrop { opacity: 0; pointer-events: none; }

        /* æ‚¬æµ®æŒ‰é’® (FAB) */
        #floatingGenerateBtn {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 8px 20px -4px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255,255,255,0.2) inset;
        }
        #floatingGenerateBtn:active { transform: scale(0.92); }
        /* åŠ è½½æ—¶çš„æ—‹è½¬åŠ¨ç”» */
        .spin-slow { animation: spin 2s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* ä¾§è¾¹æ åŠ¨ç”» */
        .drawer { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .drawer-open { transform: translateX(0); }
        .drawer-closed { transform: translateX(-100%); }

        /* æ»‘å—ç¾åŒ– */
        input[type=range] {
            -webkit-appearance: none; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #ffffff; border: 1px solid #d1d5db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: -6px; cursor: pointer; transition: transform 0.2s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 2px;
        }
        html.dark input[type=range]::-webkit-slider-thumb { background: #334155; border-color: #64748b; }
        html.dark input[type=range]::-webkit-slider-runnable-track { background: #334155; }

        /* å†å²ç½‘æ ¼ */
        .gallery-item { border: 1px solid transparent; transition: all 0.3s; }
        .gallery-item:hover { border-color: rgba(0,0,0,0.1); transform: translateY(-2px); }
        html.dark .gallery-item:hover { border-color: rgba(255,255,255,0.1); }
    </style>
</head>

<body class="h-screen-dvh w-screen overflow-hidden flex flex-col md:flex-row">

    <!-- å·¦ä¾§æŠ½å±‰ï¼šèµ„æºåº“ (ä¿æŒåŠŸèƒ½ä¸å˜ï¼Œä¼˜åŒ–UI) -->
    <div id="sideDrawer" class="absolute inset-y-0 left-0 w-80 bg-white/95 dark:bg-slate-900/95 backdrop-blur-2xl z-50 drawer drawer-closed flex flex-col border-r border-gray-100 dark:border-gray-800 shadow-[20px_0_50px_-20px_rgba(0,0,0,0.1)]">
        <div class="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-800 shrink-0">
            <h2 class="font-medium text-lg text-gray-800 dark:text-gray-100 flex items-center gap-2">
                <i data-lucide="library" class="w-5 h-5 text-gray-400"></i> åˆ›æ„èµ„æºåº“
            </h2>
            <button onclick="toggleDrawer()" class="p-2 hover:bg-gray-50 dark:hover:bg-slate-800 rounded-full text-gray-400 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="p-2 border-b border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-slate-900/50 shrink-0 flex gap-2">
            <button onclick="switchDrawerTab('search')" id="tab-search" class="flex-1 py-2 text-xs font-medium rounded-lg transition-all text-gray-900 bg-white shadow-sm border border-gray-200 dark:bg-slate-800 dark:border-gray-700 dark:text-gray-200">æœè¯</button>
            <button onclick="switchDrawerTab('preset')" id="tab-preset" class="flex-1 py-2 text-xs font-medium rounded-lg transition-all text-gray-500 hover:text-gray-900 dark:text-gray-400">é¢„è®¾</button>
        </div>
        <!-- æœç´¢ -->
        <div id="view-search" class="flex flex-col flex-1 overflow-hidden">
            <div class="p-4 border-b border-gray-100 dark:border-gray-800 shrink-0">
                <div class="flex gap-2 relative group">
                    <input type="text" id="tagSearchInput" placeholder="è¾“å…¥å…³é”®è¯..." class="art-input w-full px-4 py-2.5 rounded-xl text-sm outline-none">
                    <button id="tagSearchBtn" class="px-4 py-2 bg-gray-900 dark:bg-white text-white dark:text-gray-900 text-xs font-bold rounded-xl active:scale-95 transition-transform">GO</button>
                </div>
            </div>
            <div id="tagResults" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scroll"><div class="text-center mt-20 text-xs text-gray-400 font-light tracking-wide">è¾“å…¥ä¸­æ–‡/è‹±æ–‡å…³é”®è¯å¼€å§‹æ¢ç´¢</div></div>
        </div>
        <!-- é¢„è®¾ -->
        <div id="view-preset" class="flex flex-col flex-1 overflow-hidden hidden">
            <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-800 flex gap-2 justify-center shrink-0">
                <button onclick="renderPresets('v3')" id="btn-pre-v3" class="px-4 py-1.5 rounded-full text-[10px] font-bold border transition-all">V3</button>
                <button onclick="renderPresets('v4.5')" id="btn-pre-v4" class="px-4 py-1.5 rounded-full text-[10px] font-bold border transition-all">V4.5</button>
            </div>
            <div id="presetGrid" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 gap-3 content-start custom-scroll"></div>
        </div>
    </div>
    <div id="drawerOverlay" onclick="toggleDrawer()" class="fixed inset-0 bg-gray-900/10 backdrop-blur-[2px] z-40 hidden transition-opacity duration-300"></div>

    <!-- 
        ================= å¸ƒå±€æ ¸å¿ƒ =================
    -->

    <!-- é¢æ¿ Bï¼šé¢„è§ˆä¸å›¾åº“ (åº•å±‚å…¨å±) -->
    <!-- æ¡Œé¢ç«¯ï¼šflex-1 order-2 -->
    <div class="absolute inset-0 md:relative md:inset-auto md:flex-1 md:order-2 flex flex-col overflow-hidden transition-colors z-0">
        
        <!-- é¡¶éƒ¨æç®€å·¥å…·æ  -->
        <div class="absolute top-0 left-0 right-0 h-16 flex items-center justify-between px-4 md:px-8 z-10 pointer-events-none">
            <!-- è§†å›¾åˆ‡æ¢èƒ¶å›Š -->
            <div class="pointer-events-auto shadow-sm rounded-full p-1 bg-white/80 dark:bg-slate-800/80 backdrop-blur border border-gray-100 dark:border-gray-700 flex gap-1">
                <button onclick="switchRightView('preview')" id="viewBtnPreview" class="px-4 py-1.5 text-xs font-semibold rounded-full bg-gray-900 text-white transition-all shadow-md">ç”»å¸ƒ</button>
                <button onclick="switchRightView('history')" id="viewBtnHistory" class="px-4 py-1.5 text-xs font-semibold rounded-full text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-slate-700 transition-all">å›¾åº“</button>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div class="pointer-events-auto flex gap-2">
                <button onclick="clearAllHistory()" id="clearBtn" class="hidden p-2 rounded-full bg-white/80 dark:bg-slate-800/80 border border-gray-100 dark:border-gray-700 text-red-400 hover:text-red-500 hover:bg-red-50 transition-all shadow-sm"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                <button onclick="downloadZip()" id="zipBtn" class="hidden p-2 rounded-full bg-white/80 dark:bg-slate-800/80 border border-gray-100 dark:border-gray-700 text-blue-500 hover:text-blue-600 hover:bg-blue-50 transition-all shadow-sm"><i data-lucide="archive" class="w-4 h-4"></i></button>
                <button onclick="downloadImage()" id="dlBtn" class="p-2 rounded-full bg-white/80 dark:bg-slate-800/80 border border-gray-100 dark:border-gray-700 text-gray-600 dark:text-gray-300 hover:text-gray-900 transition-all shadow-sm opacity-50 cursor-not-allowed" disabled><i data-lucide="download" class="w-4 h-4"></i></button>
            </div>
        </div>

        <!-- çª—å£ 1: ç”»å¸ƒ -->
        <!-- åº•éƒ¨ padding ç•™å‡ºç©ºé—´é˜²æ­¢è¢«é®æŒ¡ -->
        <div id="previewArea" class="flex-1 w-full h-full flex flex-col items-center justify-center p-4 pb-24 md:p-10 relative overflow-hidden">
            <div id="placeholder" class="text-center transition-all duration-500 transform hover:scale-105 cursor-default">
                <div class="w-20 h-20 bg-gradient-to-br from-white to-gray-50 dark:from-slate-800 dark:to-slate-900 rounded-[2rem] shadow-art border border-white/50 dark:border-white/5 flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="image" class="w-8 h-8 text-gray-300 dark:text-slate-600"></i>
                </div>
                <p class="text-xs font-medium text-gray-400 dark:text-slate-500 tracking-widest uppercase">Opus Art</p>
                <div id="modelBadge" class="md:hidden mt-3 text-[10px] font-bold text-gray-300 dark:text-slate-600 bg-white/50 dark:bg-slate-800/50 px-3 py-1 rounded-full border border-gray-100 dark:border-slate-700">V3</div>
            </div>

            <div class="relative w-full h-full flex items-center justify-center">
                <img id="resultImage" class="hidden max-w-full max-h-full object-contain shadow-2xl rounded-lg transition-all duration-700 opacity-0 transform scale-95">
            </div>
            
            <!-- æ‚¬æµ®æ“ä½œæ  (ä»…æœ‰å›¾æ—¶æ˜¾ç¤º) -->
            <div id="imageActions" class="absolute bottom-28 md:bottom-8 flex gap-3 opacity-0 transition-all duration-300 pointer-events-none transform translate-y-4 z-10">
                <button onclick="useCurrentPrompt()" class="pointer-events-auto px-5 py-2.5 bg-white/90 dark:bg-slate-800/90 backdrop-blur-md text-xs font-semibold text-gray-700 dark:text-gray-200 rounded-full shadow-float border border-white/50 dark:border-slate-600 hover:scale-105 transition-all flex items-center gap-2"><i data-lucide="pen-tool" class="w-3 h-3"></i> æç¤ºè¯</button>
                <button onclick="deleteCurrentImage()" class="pointer-events-auto px-5 py-2.5 bg-white/90 dark:bg-slate-800/90 backdrop-blur-md text-xs font-semibold text-red-500 rounded-full shadow-float border border-white/50 dark:border-slate-600 hover:scale-105 transition-all flex items-center gap-2"><i data-lucide="trash" class="w-3 h-3"></i> åˆ é™¤</button>
            </div>
        </div>

        <!-- çª—å£ 2: å†å²å›¾åº“ -->
        <div id="historyArea" class="flex-1 hidden w-full h-full overflow-y-auto p-4 pt-20 pb-32 md:pb-10 custom-scroll">
            <div id="galleryGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 content-start"></div>
            <div id="emptyGallery" class="hidden h-full flex flex-col items-center justify-center text-gray-300 dark:text-slate-600">
                <i data-lucide="ghost" class="w-10 h-10 mb-3 opacity-50"></i>
                <span class="text-xs font-medium">ä¸€ç‰‡è’èŠœ</span>
            </div>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯é®ç½©å±‚ -->
    <div id="mobileBackdrop" class="fixed inset-0 bg-gray-900/20 backdrop-blur-sm z-20 hidden-backdrop md:hidden transition-opacity duration-300 pointer-events-none opacity-0" onclick="toggleMobileControls(false)"></div>

    <!-- é¢æ¿ Aï¼šæ§åˆ¶å° (åº•éƒ¨æŠ½å±‰) -->
    <div id="mobileControls" class="collapsed absolute bottom-0 left-0 right-0 md:relative md:h-full md:w-[400px] glass-panel flex flex-col z-30 shadow-[0_-10px_60px_-15px_rgba(0,0,0,0.1)] md:shadow-xl md:order-1 rounded-t-[2rem] md:rounded-none border-t border-white/60 dark:border-slate-700/50">
        
        <!-- æŠŠæ‰‹ (ç‚¹å‡»å±•å¼€/æ”¶èµ·) -->
        <div class="md:hidden w-full flex flex-col items-center pt-3 pb-2 cursor-pointer touch-none" onclick="toggleMobileControls()">
            <div class="w-10 h-1 bg-gray-300 dark:bg-slate-600 rounded-full mb-2"></div>
            <!-- æ”¶èµ·çŠ¶æ€ä¸‹çš„ç²¾ç®€æ ‡é¢˜æ  -->
            <div class="flex items-center justify-between w-full px-6 text-xs font-medium text-gray-500 dark:text-gray-400">
                <span class="flex items-center gap-1"><i data-lucide="sliders-horizontal" class="w-3 h-3"></i> å‚æ•°è®¾ç½®</span>
                <span id="modelStatusMini" class="font-mono text-[10px] bg-gray-100 dark:bg-slate-800 px-2 py-0.5 rounded">V3</span>
            </div>
        </div>

        <!-- å®Œæ•´å¤´éƒ¨ (å±•å¼€æ—¶æ˜¾ç¤ºæ›´å¤š) -->
        <div class="hidden md:block px-6 py-5 border-b border-gray-100 dark:border-gray-800 shrink-0">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <button onclick="toggleDrawer()" class="p-2 -ml-2 hover:bg-gray-50 dark:hover:bg-slate-800 rounded-xl transition-all text-gray-400 hover:text-gray-800"><i data-lucide="menu" class="w-5 h-5"></i></button>
                    <h1 class="text-base font-bold text-gray-800 dark:text-gray-100 tracking-tight">Opus Art</h1>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-50 dark:hover:bg-slate-800 text-gray-400 transition-colors"><i data-lucide="moon" class="w-4 h-4 block dark:hidden"></i><i data-lucide="sun" class="w-4 h-4 hidden dark:block"></i></button>
                    <button onclick="enterAdminToken()" id="adminLockBtn" class="p-2 rounded-full hover:bg-gray-50 dark:hover:bg-slate-800 text-gray-400 transition-colors"><i data-lucide="lock" class="w-4 h-4"></i></button>
                </div>
            </div>
            <!-- æ¨¡å‹åˆ‡æ¢ -->
            <div class="relative bg-gray-100/50 dark:bg-slate-800/50 p-1 rounded-xl flex border border-gray-200/50 dark:border-gray-700/50">
                <input type="radio" name="model_version" id="model-v3" value="v3" class="hidden" checked onchange="updateModelUI('v3')">
                <input type="radio" name="model_version" id="model-v4" value="v4.5" class="hidden" onchange="updateModelUI('v4.5')">
                <div class="switch-bg absolute top-1 bottom-1 left-1 w-[calc(50%-4px)] bg-white dark:bg-slate-700 rounded-lg shadow-sm transition-transform duration-300 z-0"></div>
                <label for="model-v3" class="flex-1 text-center py-2 text-xs font-semibold z-10 cursor-pointer text-gray-500 dark:text-gray-400 relative transition-colors">NAI V3</label>
                <label for="model-v4" class="flex-1 text-center py-2 text-xs font-semibold z-10 cursor-pointer text-gray-500 dark:text-gray-400 relative flex items-center justify-center gap-1 transition-colors">V4.5 <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span></label>
            </div>
        </div>

        <!-- æ»šåŠ¨å‚æ•°åŒº -->
        <div class="controls-body flex-1 overflow-y-auto p-6 space-y-6 custom-scroll relative">
            <div class="space-y-2">
                <div class="flex justify-between items-center px-1">
                    <label class="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest">æ­£å‘æç¤ºè¯</label>
                    <button onclick="openPresets()" class="text-[10px] text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors flex items-center gap-1"><i data-lucide="layout-grid" class="w-3 h-3"></i> é¢„è®¾åº“</button>
                </div>
                <textarea id="prompt" rows="3" class="art-input w-full px-4 py-3 rounded-xl text-sm outline-none shadow-sm resize-none text-gray-700 dark:text-gray-200" placeholder="High quality, masterpiece..."></textarea>
            </div>
            
            <div class="space-y-2">
                <label class="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest px-1">è´Ÿå‘æç¤ºè¯</label>
                <textarea id="negativePrompt" rows="2" class="art-input w-full px-4 py-3 rounded-xl text-xs outline-none shadow-sm resize-none text-gray-600 dark:text-gray-300">lowres, bad anatomy, bad hands, text, error</textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-gray-400 dark:text-gray-500 px-1">ç”»å¹…æ¯”ä¾‹</label>
                    <div class="relative">
                        <select id="resolution" class="art-input w-full px-4 py-3 rounded-xl text-xs font-medium outline-none shadow-sm appearance-none text-gray-700 dark:text-gray-200 cursor-pointer">
                            <option value="832,1216">Portrait</option>
                            <option value="1216,832">Landscape</option>
                            <option value="1024,1024">Square</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-3 h-3 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-gray-400 dark:text-gray-500 px-1">é‡‡æ ·ç®—æ³•</label>
                    <div class="relative">
                        <select id="sampler" class="art-input w-full px-4 py-3 rounded-xl text-xs font-medium outline-none shadow-sm appearance-none text-gray-700 dark:text-gray-200 cursor-pointer">
                            <option value="k_euler">Euler</option>
                            <option value="k_euler_ancestral">Euler A</option>
                            <option value="k_dpmpp_2m">DPM++ 2M</option>
                            <option value="k_dpmpp_sde">SDE</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-3 h-3 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>
            </div>

            <div class="pt-4 border-t border-gray-100 dark:border-gray-800 space-y-5">
                <div class="space-y-3">
                    <div class="flex justify-between text-xs px-1"><span class="text-gray-500">ç”Ÿæˆæ­¥æ•°</span><span id="stepsValue" class="font-mono font-bold text-gray-900 dark:text-gray-100">28</span></div>
                    <input type="range" id="steps" min="1" max="28" value="28" class="w-full h-1.5 bg-gray-200 dark:bg-slate-700 rounded-full appearance-none cursor-pointer">
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between text-xs px-1"><span class="text-gray-500">ç›¸å…³æ€§ (Scale)</span><span id="scaleValue" class="font-mono font-bold text-gray-900 dark:text-gray-100">5.0</span></div>
                    <input type="range" id="scale" min="1" max="20" value="5" step="0.5" class="w-full h-1.5 bg-gray-200 dark:bg-slate-700 rounded-full appearance-none cursor-pointer">
                </div>
            </div>
            <div class="h-10 md:hidden"></div> <!-- å«åº• -->
        </div>
        
        <!-- æ¡Œé¢ç«¯åº•éƒ¨æŒ‰é’® (ç§»åŠ¨ç«¯éšè—ï¼Œä½¿ç”¨æ‚¬æµ®æŒ‰é’®) -->
        <div class="hidden md:block p-6 border-t border-gray-100 dark:border-gray-800 bg-white/80 dark:bg-slate-900/80 backdrop-blur z-20">
            <button id="desktopGenerateBtn" class="w-full group flex items-center justify-center gap-2 py-4 px-4 bg-gray-900 dark:bg-white hover:bg-black dark:hover:bg-gray-100 text-white dark:text-gray-900 text-sm font-bold rounded-2xl transition-all shadow-xl hover:shadow-2xl hover:-translate-y-0.5 active:scale-[0.98]">
                <span id="btnIcon"><i data-lucide="sparkles" class="w-4 h-4 text-yellow-300 dark:text-yellow-600"></i></span>
                <span id="btnText">å…è´¹ç”Ÿæˆ</span>
            </button>
        </div>
    </div>

    <!-- ğŸ“± ç§»åŠ¨ç«¯æ‚¬æµ®ç”ŸæˆæŒ‰é’® (FAB) -->
    <button id="floatingGenerateBtn" class="md:hidden fixed bottom-6 right-6 w-14 h-14 bg-gray-900 dark:bg-white text-white dark:text-gray-900 rounded-full shadow-float flex items-center justify-center z-50 transition-all active:scale-90">
        <i data-lucide="sparkles" class="w-6 h-6 text-yellow-300 dark:text-yellow-600"></i>
    </button>

    <script>
        lucide.createIcons();
        
        // --- ç§»åŠ¨ç«¯æŠ½å±‰é€»è¾‘ ---
        const mobileControls = document.getElementById('mobileControls');
        const mobileBackdrop = document.getElementById('mobileBackdrop');
        let isControlsExpanded = false;

        function toggleMobileControls(forceState) {
            if (window.innerWidth >= 768) return; 

            if (typeof forceState !== 'undefined') isControlsExpanded = forceState;
            else isControlsExpanded = !isControlsExpanded;

            if (isControlsExpanded) {
                mobileControls.classList.remove('collapsed');
                mobileControls.classList.add('expanded');
                mobileBackdrop.classList.remove('hidden-backdrop');
                mobileBackdrop.classList.remove('opacity-0', 'pointer-events-none');
            } else {
                mobileControls.classList.remove('expanded');
                mobileControls.classList.add('collapsed');
                mobileBackdrop.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        // --- æ ·å¼è”åŠ¨ ---
        const modelRadios = document.querySelectorAll('input[name="model_version"]');
        const switchBg = document.querySelector('.switch-bg');
        modelRadios.forEach(r => r.addEventListener('change', (e) => {
            const isV4 = e.target.value === 'v4.5';
            switchBg.style.transform = isV4 ? 'translateX(100%)' : 'translateX(0)';
            // æ›´æ–°ç§»åŠ¨ç«¯è¿·ä½ çŠ¶æ€
            const mini = document.getElementById('modelStatusMini');
            if(mini) mini.innerText = isV4 ? 'V4.5' : 'V3';
        }));

        // --- ä¸»é¢˜åˆ‡æ¢ ---
        function initTheme() {
            if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else document.documentElement.classList.remove('dark');
        }
        initTheme();
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark'); localStorage.setItem('color-theme', 'light');
            } else {
                document.documentElement.classList.add('dark'); localStorage.setItem('color-theme', 'dark');
            }
        }

        // --- æ ¸å¿ƒå˜é‡ ---
        let currentRightView = 'preview';
        let currentImageId = null;
        let currentImageData = null;

        const els = {
            prompt: document.getElementById('prompt'),
            negative: document.getElementById('negativePrompt'),
            resolution: document.getElementById('resolution'),
            steps: document.getElementById('steps'),
            scale: document.getElementById('scale'),
            sampler: document.getElementById('sampler'),
            // æŒ‰é’®
            deskBtn: document.getElementById('desktopGenerateBtn'),
            floatBtn: document.getElementById('floatingGenerateBtn'),
            
            adminLockBtn: document.getElementById('adminLockBtn'),
            sideDrawer: document.getElementById('sideDrawer'),
            drawerOverlay: document.getElementById('drawerOverlay'),
            tagSearchInput: document.getElementById('tagSearchInput'),
            tagResults: document.getElementById('tagResults'),
            tagSearchBtn: document.getElementById('tagSearchBtn'),
            viewSearch: document.getElementById('view-search'),
            viewPreset: document.getElementById('view-preset'),
            tabSearch: document.getElementById('tab-search'),
            tabPreset: document.getElementById('tab-preset'),
            presetGrid: document.getElementById('presetGrid'),
            btnPreV3: document.getElementById('btn-pre-v3'),
            btnPreV4: document.getElementById('btn-pre-v4'),
            previewArea: document.getElementById('previewArea'),
            historyArea: document.getElementById('historyArea'),
            viewToggle: document.getElementById('viewToggle'),
            viewBtnPreview: document.getElementById('viewBtnPreview'),
            viewBtnHistory: document.getElementById('viewBtnHistory'),
            resultImg: document.getElementById('resultImage'),
            placeholder: document.getElementById('placeholder'),
            dlBtn: document.getElementById('dlBtn'),
            zipBtn: document.getElementById('zipBtn'),
            clearBtn: document.getElementById('clearBtn'),
            galleryGrid: document.getElementById('galleryGrid'),
            emptyGallery: document.getElementById('emptyGallery'),
            imageActions: document.getElementById('imageActions'),
            stepsVal: document.getElementById('stepsValue'),
            scaleVal: document.getElementById('scaleValue'),
            modelBadge: document.getElementById('modelBadge')
        };

        // --- IndexedDB ---
        const DB_NAME = 'nai_opus_db';
        const STORE_NAME = 'history';
        let db;
        const initDB = () => {
            const r = indexedDB.open(DB_NAME, 1);
            r.onupgradeneeded = e => { if(!e.target.result.objectStoreNames.contains(STORE_NAME)) e.target.result.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true }); };
            r.onsuccess = e => { db = e.target.result; loadGallery(); };
        };
        initDB();

        function saveToHistory(imgBase64, prompt, model) {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).add({ image: imgBase64, prompt, model, date: Date.now() }).onsuccess = (e) => {
                currentImageId = e.target.result;
                currentImageData = { image: imgBase64, prompt, model };
                showImageActions(true);
                loadGallery();
            };
        }

        function deleteCurrentImage() {
            if (!currentImageId || !db) return;
            if (!confirm("åˆ é™¤æ­¤å›¾ç‰‡ï¼Ÿ")) return;
            db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME).delete(currentImageId).onsuccess = () => {
                resetPreview(); loadGallery();
            };
        }

        window.clearAllHistory = function() {
            if (!db || !confirm("æ¸…ç©ºæ‰€æœ‰å†å²ï¼Ÿ")) return;
            db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME).clear().onsuccess = () => {
                loadGallery(); resetPreview();
            };
        };

        function loadGallery() {
            if (!db) return;
            db.transaction(STORE_NAME, 'readonly').objectStore(STORE_NAME).getAll().onsuccess = (e) => {
                renderGallery(e.target.result.reverse());
            };
        }

        function renderGallery(items) {
            els.galleryGrid.innerHTML = '';
            if (items.length === 0) {
                els.emptyGallery.classList.remove('hidden');
                els.zipBtn.classList.add('hidden');
                els.clearBtn.classList.add('hidden');
            } else {
                els.emptyGallery.classList.add('hidden');
                if (currentRightView === 'history') {
                    els.zipBtn.classList.remove('hidden');
                    els.clearBtn.classList.remove('hidden');
                }
                items.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'gallery-item aspect-square bg-gray-100 dark:bg-slate-800 rounded-xl overflow-hidden relative group border dark:border-slate-700 cursor-pointer shadow-sm';
                    el.innerHTML = `<img src="${item.image}" class="w-full h-full object-cover">`;
                    el.onclick = () => loadPreviewFromHistory(item);
                    els.galleryGrid.appendChild(el);
                });
            }
        }

        function loadPreviewFromHistory(item) {
            switchRightView('preview');
            els.resultImg.src = item.image;
            els.placeholder.classList.add('hidden');
            els.resultImg.classList.remove('hidden', 'scale-95', 'opacity-0');
            els.dlBtn.disabled = false;
            els.dlBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            currentImageId = item.id;
            currentImageData = item;
            showImageActions(true);
            toggleMobileControls(false); 
        }

        function useCurrentPrompt() {
            if (!currentImageData) return;
            els.prompt.value = currentImageData.prompt;
            els.prompt.classList.add('bg-blue-50', 'dark:bg-blue-900/30');
            setTimeout(() => els.prompt.classList.remove('bg-blue-50', 'dark:bg-blue-900/30'), 500);
            toggleMobileControls(true);
        }

        function resetPreview() {
            els.resultImg.src = '';
            els.resultImg.classList.add('hidden', 'scale-95', 'opacity-0');
            els.placeholder.classList.remove('hidden');
            els.dlBtn.disabled = true;
            els.dlBtn.classList.add('opacity-50', 'cursor-not-allowed');
            showImageActions(false);
            currentImageId = null;
        }

        function showImageActions(show) {
            if (show) els.imageActions.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-4');
            else els.imageActions.classList.add('opacity-0', 'pointer-events-none', 'translate-y-4');
        }

        window.downloadZip = function() {
            if (!db) return;
            db.transaction(STORE_NAME, 'readonly').objectStore(STORE_NAME).getAll().onsuccess = (e) => {
                const items = e.target.result;
                if (!items.length) return;
                const zip = new JSZip();
                const folder = zip.folder("novelai_gallery");
                items.forEach((item, idx) => folder.file(`image_${idx}.png`, item.image.split(',')[1], {base64: true}));
                zip.generateAsync({type:"blob"}).then(c => {
                    const a = document.createElement("a");
                    a.href = URL.createObjectURL(c);
                    a.download = `history_${Date.now()}.zip`;
                    a.click();
                });
            };
        };

        function switchRightView(view) {
            currentRightView = view;
            const activeClass = ['bg-gray-900', 'text-white'];
            const inactiveClass = ['text-gray-500', 'dark:text-gray-400', 'hover:text-gray-900', 'dark:hover:text-gray-200'];
            
            if (view === 'preview') {
                els.viewBtnPreview.className = `active ${activeClass.join(' ')}`;
                els.viewBtnHistory.className = inactiveClass.join(' ');
                els.previewArea.classList.remove('hidden');
                els.historyArea.classList.add('hidden');
                els.zipBtn.classList.add('hidden');
                els.clearBtn.classList.add('hidden');
                els.dlBtn.classList.remove('hidden');
            } else {
                els.viewBtnPreview.className = inactiveClass.join(' ');
                els.viewBtnHistory.className = `active ${activeClass.join(' ')}`;
                els.previewArea.classList.add('hidden');
                els.historyArea.classList.remove('hidden');
                loadGallery();
                els.zipBtn.classList.remove('hidden');
                els.clearBtn.classList.remove('hidden');
                els.dlBtn.classList.add('hidden');
            }
            els.viewToggle.dataset.state = view;
        }

        // --- ç”Ÿæˆä¸äº¤äº’ ---
        els.steps.addEventListener('input', e => els.stepsVal.textContent = e.target.value);
        els.scale.addEventListener('input', e => els.scaleVal.textContent = parseFloat(e.target.value).toFixed(1));
        
        function updateModelUI(version) {
            const sw = document.querySelector('.switch-bg');
            if (version === 'v4.5') sw.style.transform = 'translateX(100%)';
            else sw.style.transform = 'translateX(0)';
            
            const badge = document.getElementById('modelBadge');
            const mini = document.getElementById('modelStatusMini');
            const txt = version === 'v4.5' ? "V4.5" : "V3";
            if(badge) badge.innerText = txt + " MODE";
            if(mini) mini.innerText = txt;
        }

        function setLoading(loading) {
            // åŒæ—¶æ§åˆ¶æ¡Œé¢æŒ‰é’®å’Œæ‚¬æµ®æŒ‰é’®
            [els.deskBtn, els.floatBtn].forEach(btn => {
                btn.disabled = loading;
                if (loading) {
                    // å¯¹äºæ‚¬æµ®æŒ‰é’®ï¼Œæ˜¾ç¤º loading çŠ¶æ€
                    if(btn.id === 'floatingGenerateBtn') {
                        btn.innerHTML = '<span class="loader"></span>';
                        btn.classList.add('scale-90');
                    } else {
                        // æ¡Œé¢æŒ‰é’®
                        btn.querySelector('#btnIcon').classList.add('hidden');
                        btn.querySelector('.loader').classList.remove('hidden');
                        btn.querySelector('#btnText').textContent = "ç”Ÿæˆä¸­...";
                    }
                } else {
                    if(btn.id === 'floatingGenerateBtn') {
                        btn.innerHTML = '<i data-lucide="sparkles" class="w-6 h-6 text-yellow-300 dark:text-yellow-600"></i>';
                        btn.classList.remove('scale-90');
                        lucide.createIcons();
                    } else {
                        btn.querySelector('#btnIcon').classList.remove('hidden');
                        btn.querySelector('.loader').classList.add('hidden');
                        btn.querySelector('#btnText').textContent = "å…è´¹ç”Ÿæˆ";
                    }
                }
            });
            
            if (loading && !els.resultImg.classList.contains('hidden')) {
                els.resultImg.classList.add('opacity-50', 'blur-sm');
            } else if (!loading) {
                els.resultImg.classList.remove('opacity-50', 'blur-sm');
            }
        }

        async function doGenerate() {
            const promptText = els.prompt.value.trim();
            if (!promptText) { 
                els.prompt.focus(); 
                // å¦‚æœåœ¨æ”¶èµ·çŠ¶æ€ï¼Œç‚¹å‡»ç”Ÿæˆè‹¥æ— æç¤ºè¯ï¼Œè‡ªåŠ¨å±•å¼€
                toggleMobileControls(true);
                return; 
            }
            const selectedVersion = document.querySelector('input[name="model_version"]:checked').value;
            const [w, h] = els.resolution.value.split(',').map(Number);
            const adminToken = localStorage.getItem('nai_admin_token') || "";
            
            if (currentRightView !== 'preview') switchRightView('preview');
            toggleMobileControls(false); // ç”Ÿæˆæ—¶æ”¶èµ·

            setLoading(true);
            try {
                const payload = {
                    version: selectedVersion, prompt: promptText, negative_prompt: els.negative.value.trim(),
                    width: w, height: h, steps: parseInt(els.steps.value), scale: parseFloat(els.scale.value), sampler: els.sampler.value
                };
                const res = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-token': adminToken },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok || data.error) throw new Error(data.error || `Server Error: ${res.status}`);
                
                const tempImg = new Image();
                tempImg.src = data.image;
                tempImg.onload = () => {
                    els.resultImg.src = data.image;
                    els.placeholder.classList.add('hidden');
                    els.resultImg.classList.remove('hidden', 'scale-95', 'opacity-0');
                    els.dlBtn.disabled = false;
                    els.dlBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    setLoading(false);
                    saveToHistory(data.image, promptText, selectedVersion);
                };
            } catch (err) {
                console.error(err);
                setLoading(false);
                toggleMobileControls(true); // å‡ºé”™å±•å¼€
                if (err.message.includes('429')) alert("âš ï¸ ä»Šæ—¥é¢åº¦å·²ç”¨å®Œ");
                else alert("ç”Ÿæˆå¤±è´¥: " + err.message);
            }
        }

        // ç»‘å®šä¸¤ä¸ªæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        els.deskBtn.addEventListener('click', doGenerate);
        els.floatBtn.addEventListener('click', doGenerate);

        function downloadImage() {
            if (els.resultImg.src && !els.resultImg.classList.contains('hidden')) {
                const a = document.createElement('a');
                a.href = els.resultImg.src;
                a.download = `novelai-gen-${Date.now()}.png`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }
        }

        // --- æŠ½å±‰é€»è¾‘ ---
        function toggleDrawer() {
            els.sideDrawer.classList.toggle('drawer-open');
            els.sideDrawer.classList.toggle('drawer-closed');
            els.drawerOverlay.classList.toggle('hidden');
        }
        function switchDrawerTab(tab) {
            if (tab === 'search') {
                els.viewSearch.classList.remove('hidden'); els.viewPreset.classList.add('hidden');
                els.tabSearch.classList.add('active'); els.tabPreset.classList.remove('active');
            } else {
                els.viewSearch.classList.add('hidden'); els.viewPreset.classList.remove('hidden');
                els.tabSearch.classList.remove('active'); els.tabPreset.classList.add('active');
                renderPresets(document.querySelector('input[name="model_version"]:checked').value);
            }
        }
        function openPresets() { if(!els.sideDrawer.classList.contains('drawer-open')) toggleDrawer(); switchDrawerTab('preset'); }

        function enterAdminToken() {
            const cur = localStorage.getItem('nai_admin_token');
            const t = prompt(cur ? "æ¸…ç©ºä»¥æ³¨é”€" : "è¾“å…¥ç®¡ç†å‘˜å¯†ç ");
            if (t !== null) {
                if (!t.trim()) localStorage.removeItem('nai_admin_token');
                else localStorage.setItem('nai_admin_token', t.trim());
                checkAdminStatus();
            }
        }
        function checkAdminStatus() {
            const t = localStorage.getItem('nai_admin_token');
            if (t) els.adminLockBtn.innerHTML = '<i data-lucide="unlock" class="w-4 h-4 text-green-500"></i>';
            else els.adminLockBtn.innerHTML = '<i data-lucide="lock" class="w-4 h-4 text-gray-300 dark:text-gray-500"></i>';
            lucide.createIcons();
        }
        checkAdminStatus();

        // --- èµ„æºåº“é€»è¾‘ ---
        let tagData = {};
        fetch('all_tags.txt').then(r=>r.json()).then(d=>tagData=d).catch(()=>{});
        els.tagSearchBtn.onclick = () => {
            const q = els.tagSearchInput.value.toLowerCase().trim();
            if(!q) return;
            const res = Object.entries(tagData).filter(([e,c])=>e.includes(q)||c.includes(q));
            els.tagResults.innerHTML = '';
            res.forEach(([en,cn]) => {
                const d = document.createElement('div');
                d.className = "p-3 hover:bg-gray-50 dark:hover:bg-slate-800 border-b border-gray-100 dark:border-gray-800 cursor-pointer transition-colors";
                d.innerHTML = `<div class="text-sm font-medium text-gray-800 dark:text-gray-200">${en}</div><div class="text-xs text-gray-400 dark:text-gray-500">${cn}</div>`;
                d.onclick = () => {
                    els.prompt.value += (els.prompt.value ? ', ' : '') + en;
                };
                els.tagResults.appendChild(d);
            });
        };

        const presetFiles = [
            { id: '1_v3', model: 'v3', name: 'æœªçŸ¥' }, { id: '2_v3', model: 'v3', name: 'æœªçŸ¥' },
            { id: '1_v4.5', model: 'v4.5', name: 'é“ƒå…°' }, { id: '2_v4.5', model: 'v4.5', name: 'æœªçŸ¥' }
        ];
        function renderPresets(model) {
            const active = "bg-gray-900 text-white dark:bg-slate-100 dark:text-gray-900";
            const inactive = "bg-white text-gray-500 border dark:bg-slate-800 dark:text-gray-400 dark:border-gray-700";
            if(model==='v3') { els.btnPreV3.className=`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${active}`; els.btnPreV4.className=`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${inactive}`; }
            else { els.btnPreV3.className=`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${inactive}`; els.btnPreV4.className=`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${active}`; }
            
            els.presetGrid.innerHTML = '';
            const filtered = presetFiles.filter(p => p.model === model);
            if(filtered.length === 0) { els.presetGrid.innerHTML = '<div class="col-span-2 text-center text-xs text-gray-400">æš‚æ— é¢„è®¾</div>'; return; }
            filtered.forEach(p => {
                const d = document.createElement('div');
                d.className = "group cursor-pointer flex flex-col gap-2";
                d.innerHTML = `<div class="aspect-[2/3] w-full rounded-lg bg-gray-100 dark:bg-slate-700 relative overflow-hidden group-hover:shadow-lg transition-all"><img src="presets/${p.id}.png" class="w-full h-full object-cover"></div><span class="text-xs text-center text-gray-500 dark:text-gray-400">${p.name}</span>`;
                d.onclick = async () => {
                    try {
                        const res = await fetch(`presets/${p.id}.txt`);
                        if(res.ok) {
                            els.prompt.value = (await res.text()).trim();
                            toggleMobileControls(true);
                            if(window.innerWidth < 768) toggleDrawer();
                        }
                    } catch(e){}
                };
                els.presetGrid.appendChild(d);
            });
        }
    </script>
</body>
</html>
