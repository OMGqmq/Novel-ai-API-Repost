<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NovelAI Opus Free</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { bg: '#0f172a', panel: '#1e293b', border: '#334155', text: '#e2e8f0' }
                    },
                    height: {
                        'screen-dvh': '100dvh'
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            background-image: radial-gradient(at 0% 0%, rgba(229, 231, 235, 0.5) 0px, transparent 50%), radial-gradient(at 100% 0%, rgba(209, 213, 219, 0.5) 0px, transparent 50%), linear-gradient(to bottom right, #f9fafb, #f3f4f6);
            background-size: 100% 100%;
            background-attachment: fixed;
            overscroll-behavior: none;
        }
        
        html.dark body {
            background-color: #0f172a;
            background-image: radial-gradient(at 0% 0%, rgba(30, 41, 59, 0.5) 0px, transparent 50%), radial-gradient(at 100% 0%, rgba(15, 23, 42, 0.5) 0px, transparent 50%), linear-gradient(to bottom right, #0f172a, #1e293b);
        }

        /* 隐藏滚动条但保留功能 */
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        html.dark .custom-scroll::-webkit-scrollbar-thumb { background: #475569; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-right: 1px solid rgba(229, 231, 235, 0.6);
        }
        html.dark .glass-panel {
            background: rgba(30, 41, 59, 0.95);
            border-right: 1px solid rgba(51, 65, 85, 0.6);
        }

        .drawer { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .drawer-open { transform: translateX(0); }
        .drawer-closed { transform: translateX(-100%); }
        
        .tab-btn { position: relative; transition: color 0.3s; }
        .tab-btn.active::after { 
            content: ''; position: absolute; bottom: 0; left: 50%; width: 40%; height: 2px;
            background: currentColor; transform: translateX(-50%); 
        }

        .loader {
            width: 18px; height: 18px; border: 2px solid currentColor;
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; animation: rotation 0.8s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .view-toggle {
            background: rgba(243, 244, 246, 0.8);
            border: 1px solid rgba(229, 231, 235, 0.8);
            border-radius: 8px; padding: 2px; display: flex; position: relative;
        }
        html.dark .view-toggle { background: rgba(15, 23, 42, 0.8); border-color: rgba(51, 65, 85, 0.8); }

        .view-toggle button {
            position: relative; z-index: 2; padding: 4px 12px; font-size: 11px; font-weight: 600;
            color: #6b7280; transition: color 0.2s; border-radius: 6px; flex: 1; text-align: center;
        }
        html.dark .view-toggle button { color: #94a3b8; }
        .view-toggle button.active { color: #111827; }
        html.dark .view-toggle button.active { color: #f1f5f9; }

        .view-toggle-bg {
            position: absolute; top: 2px; bottom: 2px; left: 2px; width: calc(50% - 2px);
            background: white; border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1;
        }
        html.dark .view-toggle-bg { background: #334155; }
        .view-toggle[data-state="history"] .view-toggle-bg { transform: translateX(100%); }

        /* 移动端高度分配 */
        @media (max-width: 768px) {
            .mobile-preview-height { height: 40%; flex-shrink: 0; }
            .mobile-controls-height { height: 60%; flex-shrink: 0; }
        }
        
        .switch-bg {
            position: absolute; height: calc(100% - 8px); width: calc(50% - 6px);
            top: 4px; left: 4px; background: white; border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 0;
        }
        html.dark .switch-bg { background: #334155; }
        #model-v4:checked ~ .switch-bg { transform: translateX(calc(100% + 4px)); }
    </style>
</head>

<body class="text-gray-600 dark:text-gray-300 h-screen-dvh w-screen overflow-hidden flex flex-col md:flex-row transition-colors duration-300">

    <!-- 左侧抽屉：资源库 (保持不变) -->
    <div id="sideDrawer" class="absolute inset-y-0 left-0 w-80 bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl z-50 drawer drawer-closed flex flex-col border-r border-gray-100/50 dark:border-gray-700/50 shadow-2xl">
        <div class="flex items-center justify-between p-4 border-b border-gray-100 dark:border-gray-800 shrink-0">
            <h2 class="font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
                <i data-lucide="library" class="w-4 h-4 text-blue-500"></i> 资源库
            </h2>
            <button onclick="toggleDrawer()" class="p-1.5 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg text-gray-400"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="flex border-b border-gray-100 dark:border-gray-800 bg-white/50 dark:bg-slate-900/50 shrink-0">
            <button onclick="switchDrawerTab('search')" id="tab-search" class="tab-btn active flex-1 py-3 text-xs flex justify-center items-center gap-1.5 text-blue-600 dark:text-blue-400 font-medium"><i data-lucide="search" class="w-3 h-3"></i> 搜词</button>
            <button onclick="switchDrawerTab('preset')" id="tab-preset" class="tab-btn flex-1 py-3 text-xs flex justify-center items-center gap-1.5 text-gray-500 hover:text-gray-700 dark:text-gray-400"><i data-lucide="grid" class="w-3 h-3"></i> 预设</button>
        </div>
        <div id="view-search" class="flex flex-col flex-1 overflow-hidden">
            <div class="p-4 border-b border-gray-100 dark:border-gray-800 shrink-0">
                <div class="flex gap-2 relative group">
                    <input type="text" id="tagSearchInput" placeholder="输入关键词..." class="w-full px-3 py-2 bg-gray-50 dark:bg-slate-800 border border-gray-200 dark:border-gray-700 rounded-lg text-sm outline-none focus:border-blue-400 transition-colors">
                    <button id="tagSearchBtn" class="px-3 py-2 bg-gray-900 dark:bg-slate-700 text-white text-xs font-medium rounded-lg active:scale-95">搜索</button>
                </div>
            </div>
            <div id="tagResults" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scroll"><div class="text-center mt-12 text-xs text-gray-300 dark:text-gray-600">输入中文/英文关键词</div></div>
        </div>
        <div id="view-preset" class="flex flex-col flex-1 overflow-hidden hidden">
            <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-800 flex gap-2 justify-center shrink-0">
                <button onclick="renderPresets('v3')" id="btn-pre-v3" class="px-3 py-1 rounded-full text-[10px] font-bold border transition-all">V3</button>
                <button onclick="renderPresets('v4.5')" id="btn-pre-v4" class="px-3 py-1 rounded-full text-[10px] font-bold border transition-all">V4.5</button>
            </div>
            <div id="presetGrid" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 gap-3 content-start custom-scroll"></div>
        </div>
    </div>
    <div id="drawerOverlay" onclick="toggleDrawer()" class="fixed inset-0 bg-black/20 backdrop-blur-[2px] z-40 hidden transition-opacity duration-300"></div>

    <!-- 顶部/右侧面板：预览与图库 (移动端在上方，桌面端在右侧) -->
    <!-- Order 1: 在移动端排第一 -->
    <div class="mobile-preview-height md:h-full flex-1 relative flex flex-col overflow-hidden bg-gray-50/50 dark:bg-slate-900/50 order-1 md:order-2 border-b md:border-b-0 md:border-l border-gray-200 dark:border-gray-700">
        
        <!-- 顶部极简工具栏 -->
        <div class="absolute top-0 left-0 right-0 h-10 md:h-12 flex items-center justify-between px-3 md:px-6 z-20 bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm border-b border-gray-100/50 dark:border-gray-700/50">
            <!-- 视图切换 -->
            <div class="view-toggle" id="viewToggle" data-state="preview">
                <div class="view-toggle-bg"></div>
                <button onclick="switchRightView('preview')" id="viewBtnPreview" class="active">画布</button>
                <button onclick="switchRightView('history')" id="viewBtnHistory">历史</button>
            </div>
            
            <!-- 顶部操作 -->
            <div class="flex gap-2">
                <button onclick="clearAllHistory()" id="clearBtn" class="hidden p-1.5 rounded text-red-400 hover:bg-red-50 dark:hover:bg-slate-800 transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                <button onclick="downloadZip()" id="zipBtn" class="hidden p-1.5 rounded text-blue-500 hover:bg-blue-50 dark:hover:bg-slate-800 transition-all"><i data-lucide="archive" class="w-4 h-4"></i></button>
                <button onclick="downloadImage()" id="dlBtn" class="p-1.5 rounded text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-800 transition-all opacity-50 cursor-not-allowed" disabled><i data-lucide="download" class="w-4 h-4"></i></button>
            </div>
        </div>

        <!-- 窗口 1: 画布 (绝对居中，自适应) -->
        <div id="previewArea" class="flex-1 w-full h-full flex flex-col items-center justify-center p-4 pt-12 md:p-10 relative overflow-hidden">
            <!-- 占位符 -->
            <div id="placeholder" class="text-center transition-all duration-300">
                <div class="w-12 h-12 md:w-16 md:h-16 bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex items-center justify-center mx-auto mb-2 md:mb-3">
                    <i data-lucide="image" class="w-5 h-5 md:w-6 md:h-6 text-gray-300 dark:text-gray-600"></i>
                </div>
                <p class="text-[10px] md:text-xs text-gray-400 dark:text-gray-500">Opus Free</p>
            </div>

            <!-- 图片容器：关键 CSS 确保图片永远完整显示 -->
            <div class="relative w-full h-full flex items-center justify-center">
                <img id="resultImage" class="hidden max-w-full max-h-full object-contain shadow-lg rounded-lg transition-all duration-500 opacity-0">
            </div>
            
            <!-- 悬浮操作栏 -->
            <div id="imageActions" class="absolute bottom-4 flex gap-2 opacity-0 transition-opacity pointer-events-none transform translate-y-2 z-10">
                <button onclick="useCurrentPrompt()" class="pointer-events-auto px-3 py-1.5 bg-white/90 dark:bg-slate-800/90 backdrop-blur text-[10px] font-medium text-gray-700 dark:text-gray-200 rounded-full shadow border border-gray-200 dark:border-gray-700 hover:scale-105 transition-all flex items-center gap-1"><i data-lucide="pen-tool" class="w-3 h-3"></i> 提示词</button>
                <button onclick="deleteCurrentImage()" class="pointer-events-auto px-3 py-1.5 bg-white/90 dark:bg-slate-800/90 backdrop-blur text-[10px] font-medium text-red-500 rounded-full shadow border border-gray-200 dark:border-gray-700 hover:scale-105 transition-all flex items-center gap-1"><i data-lucide="trash" class="w-3 h-3"></i> 删除</button>
            </div>
        </div>

        <!-- 窗口 2: 历史图库 (独立滚动) -->
        <div id="historyArea" class="flex-1 hidden w-full h-full overflow-y-auto p-4 pt-12 custom-scroll bg-gray-50/30 dark:bg-slate-900/30">
            <div id="galleryGrid" class="grid grid-cols-3 md:grid-cols-4 gap-2 content-start pb-10"></div>
            <div id="emptyGallery" class="hidden h-full flex flex-col items-center justify-center text-gray-400">
                <i data-lucide="ghost" class="w-6 h-6 mb-2 opacity-50"></i>
                <span class="text-[10px]">暂无历史</span>
            </div>
        </div>
    </div>

    <!-- 底部/左侧面板：控制台 (移动端在下方，桌面端在左侧) -->
    <!-- Order 2: 在移动端排第二 -->
    <div class="mobile-controls-height md:h-full w-full md:w-[400px] landscape:w-[360px] glass-panel flex flex-col z-20 shadow-xl relative order-2 md:order-1 landscape:order-1">
        
        <!-- 头部 (紧凑型) -->
        <div class="px-4 py-3 md:p-5 border-b border-gray-100 dark:border-gray-700 shrink-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <button onclick="toggleDrawer()" class="p-1.5 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg text-gray-500">
                        <i data-lucide="menu" class="w-4 h-4"></i>
                    </button>
                    <h1 class="text-sm font-semibold text-gray-800 dark:text-gray-200">控制台</h1>
                </div>
                <div class="flex gap-1">
                    <button onclick="toggleTheme()" class="p-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-slate-800 text-gray-400"><i data-lucide="moon" class="w-4 h-4 block dark:hidden"></i><i data-lucide="sun" class="w-4 h-4 hidden dark:block"></i></button>
                    <button onclick="enterAdminToken()" id="adminLockBtn" class="p-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-slate-800 text-gray-400"><i data-lucide="lock" class="w-4 h-4"></i></button>
                </div>
            </div>
            <!-- 模型切换 -->
            <div class="relative bg-gray-100/80 dark:bg-slate-800/80 p-1 rounded-lg flex border border-gray-200/50 dark:border-gray-700/50">
                <input type="radio" name="model_version" id="model-v3" value="v3" class="hidden" checked onchange="updateModelUI('v3')">
                <input type="radio" name="model_version" id="model-v4" value="v4.5" class="hidden" onchange="updateModelUI('v4.5')">
                <div class="switch-bg absolute top-1 bottom-1 left-1 w-[calc(50%-4px)] bg-white dark:bg-slate-700 rounded shadow-sm transition-transform duration-300 z-0"></div>
                <label for="model-v3" class="flex-1 text-center py-1 text-xs font-medium z-10 cursor-pointer text-gray-600 dark:text-gray-300 relative">V3</label>
                <label for="model-v4" class="flex-1 text-center py-1 text-xs font-medium z-10 cursor-pointer text-gray-600 dark:text-gray-300 relative flex items-center justify-center gap-1">V4.5 <span class="w-1 h-1 rounded-full bg-blue-500"></span></label>
            </div>
        </div>

        <!-- 滚动表单区 (Flex-1) -->
        <div class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 custom-scroll relative">
            <div class="space-y-1.5">
                <div class="flex justify-between items-center px-1">
                    <label class="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest">提示词</label>
                    <button onclick="openPresets()" class="text-[10px] text-blue-500 flex items-center gap-1 hover:underline"><i data-lucide="sparkles" class="w-3 h-3"></i> 风格</button>
                </div>
                <textarea id="prompt" rows="3" class="w-full bg-white dark:bg-slate-800 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-200 text-sm rounded-lg focus:border-blue-400 outline-none p-3 shadow-sm transition-colors resize-none" placeholder="描述你想象中的画面..."></textarea>
            </div>
            
            <div class="space-y-1.5">
                <label class="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest px-1">负向</label>
                <textarea id="negativePrompt" rows="1" class="w-full bg-white dark:bg-slate-800 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-200 text-xs rounded-lg focus:border-blue-400 outline-none p-3 shadow-sm resize-none">lowres, bad anatomy, bad hands, text, error</textarea>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-gray-400 dark:text-gray-500 px-1">画幅</label>
                    <div class="relative">
                        <select id="resolution" class="w-full bg-white dark:bg-slate-800 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-200 text-xs rounded-lg p-2.5 outline-none appearance-none">
                            <option value="832,1216">Portrait</option>
                            <option value="1216,832">Landscape</option>
                            <option value="1024,1024">Square</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-2 top-3 w-3 h-3 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-gray-400 dark:text-gray-500 px-1">采样</label>
                    <div class="relative">
                        <select id="sampler" class="w-full bg-white dark:bg-slate-800 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-200 text-xs rounded-lg p-2.5 outline-none appearance-none">
                            <option value="k_euler">Euler</option>
                            <option value="k_euler_ancestral">Euler A</option>
                            <option value="k_dpmpp_2m">DPM++ 2M</option>
                            <option value="k_dpmpp_sde">SDE</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-2 top-3 w-3 h-3 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>
            </div>

            <div class="pt-2 border-t border-gray-100 dark:border-gray-700/50 space-y-3">
                <div>
                    <div class="flex justify-between text-xs px-1 mb-1"><span class="text-gray-500">步数</span><span id="stepsValue" class="font-mono font-bold">28</span></div>
                    <input type="range" id="steps" min="1" max="28" value="28" class="w-full h-1 bg-gray-200 dark:bg-slate-700 rounded-full appearance-none cursor-pointer accent-gray-800 dark:accent-gray-400">
                </div>
                <div>
                    <div class="flex justify-between text-xs px-1 mb-1"><span class="text-gray-500">相关性</span><span id="scaleValue" class="font-mono font-bold">5.0</span></div>
                    <input type="range" id="scale" min="1" max="20" value="5" step="0.5" class="w-full h-1 bg-gray-200 dark:bg-slate-700 rounded-full appearance-none cursor-pointer accent-gray-800 dark:accent-gray-400">
                </div>
            </div>
            
            <!-- 垫底元素，防止被底部按钮遮挡 -->
            <div class="h-16"></div>
        </div>

        <!-- 底部按钮 (固定在Panel底部) -->
        <div class="p-4 border-t border-gray-100 dark:border-gray-700 bg-white/95 dark:bg-slate-900/95 backdrop-blur shrink-0 absolute bottom-0 left-0 right-0 z-20">
            <button id="generateBtn" class="w-full flex items-center justify-center gap-2 py-3.5 px-4 bg-gray-900 dark:bg-slate-100 hover:bg-black dark:hover:bg-white text-white dark:text-gray-900 text-sm font-bold rounded-xl transition-all shadow-lg active:scale-[0.98]">
                <span id="btnIcon"><i data-lucide="sparkles" class="w-4 h-4 text-yellow-400"></i></span>
                <span id="btnLoader" class="hidden"><span class="loader"></span></span>
                <span id="btnText">免费生成</span>
            </button>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        // --- 样式修正：移动端滑块背景 ---
        const modelRadios = document.querySelectorAll('input[name="model_version"]');
        const switchBg = document.querySelector('.switch-bg');
        modelRadios.forEach(r => r.addEventListener('change', (e) => {
            if (e.target.value === 'v4.5') switchBg.style.transform = 'translateX(100%)';
            else switchBg.style.transform = 'translateX(0)';
        }));

        // --- 主题切换 ---
        function initTheme() {
            if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else document.documentElement.classList.remove('dark');
        }
        initTheme();
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark'); localStorage.setItem('color-theme', 'light');
            } else {
                document.documentElement.classList.add('dark'); localStorage.setItem('color-theme', 'dark');
            }
        }

        // --- 核心变量 ---
        let currentRightView = 'preview';
        let currentImageId = null;
        let currentImageData = null;

        const els = {
            prompt: document.getElementById('prompt'),
            negative: document.getElementById('negativePrompt'),
            resolution: document.getElementById('resolution'),
            steps: document.getElementById('steps'),
            scale: document.getElementById('scale'),
            sampler: document.getElementById('sampler'),
            btn: document.getElementById('generateBtn'),
            btnText: document.getElementById('btnText'),
            btnIcon: document.getElementById('btnIcon'),
            btnLoader: document.getElementById('btnLoader'),
            adminLockBtn: document.getElementById('adminLockBtn'),
            sideDrawer: document.getElementById('sideDrawer'),
            drawerOverlay: document.getElementById('drawerOverlay'),
            tagSearchInput: document.getElementById('tagSearchInput'),
            tagResults: document.getElementById('tagResults'),
            tagSearchBtn: document.getElementById('tagSearchBtn'),
            viewSearch: document.getElementById('view-search'),
            viewPreset: document.getElementById('view-preset'),
            tabSearch: document.getElementById('tab-search'),
            tabPreset: document.getElementById('tab-preset'),
            presetGrid: document.getElementById('presetGrid'),
            btnPreV3: document.getElementById('btn-pre-v3'),
            btnPreV4: document.getElementById('btn-pre-v4'),
            previewArea: document.getElementById('previewArea'),
            historyArea: document.getElementById('historyArea'),
            viewToggle: document.getElementById('viewToggle'),
            viewBtnPreview: document.getElementById('viewBtnPreview'),
            viewBtnHistory: document.getElementById('viewBtnHistory'),
            resultImg: document.getElementById('resultImage'),
            placeholder: document.getElementById('placeholder'),
            dlBtn: document.getElementById('dlBtn'),
            zipBtn: document.getElementById('zipBtn'),
            clearBtn: document.getElementById('clearBtn'),
            galleryGrid: document.getElementById('galleryGrid'),
            emptyGallery: document.getElementById('emptyGallery'),
            imageActions: document.getElementById('imageActions'),
            stepsVal: document.getElementById('stepsValue'),
            scaleVal: document.getElementById('scaleValue')
        };

        // --- IndexedDB ---
        const DB_NAME = 'nai_opus_db';
        const STORE_NAME = 'history';
        let db;
        const initDB = () => {
            const r = indexedDB.open(DB_NAME, 1);
            r.onupgradeneeded = e => { if(!e.target.result.objectStoreNames.contains(STORE_NAME)) e.target.result.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true }); };
            r.onsuccess = e => { db = e.target.result; loadGallery(); };
        };
        initDB();

        function saveToHistory(imgBase64, prompt, model) {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).add({ image: imgBase64, prompt, model, date: Date.now() }).onsuccess = (e) => {
                currentImageId = e.target.result;
                currentImageData = { image: imgBase64, prompt, model };
                showImageActions(true);
                loadGallery();
            };
        }

        function deleteCurrentImage() {
            if (!currentImageId || !db) return;
            if (!confirm("删除此图片？")) return;
            db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME).delete(currentImageId).onsuccess = () => {
                resetPreview(); loadGallery();
            };
        }

        window.clearAllHistory = function() {
            if (!db || !confirm("清空所有历史？")) return;
            db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME).clear().onsuccess = () => {
                loadGallery(); resetPreview();
            };
        };

        function loadGallery() {
            if (!db) return;
            db.transaction(STORE_NAME, 'readonly').objectStore(STORE_NAME).getAll().onsuccess = (e) => {
                renderGallery(e.target.result.reverse());
            };
        }

        function renderGallery(items) {
            els.galleryGrid.innerHTML = '';
            if (items.length === 0) {
                els.emptyGallery.classList.remove('hidden');
                els.zipBtn.classList.add('hidden');
                els.clearBtn.classList.add('hidden');
            } else {
                els.emptyGallery.classList.add('hidden');
                if (currentRightView === 'history') {
                    els.zipBtn.classList.remove('hidden');
                    els.clearBtn.classList.remove('hidden');
                }
                items.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'gallery-item aspect-square bg-gray-100 dark:bg-slate-800 rounded-lg overflow-hidden relative group border dark:border-slate-700 cursor-pointer';
                    el.innerHTML = `<img src="${item.image}" class="w-full h-full object-cover">`;
                    el.onclick = () => loadPreviewFromHistory(item);
                    els.galleryGrid.appendChild(el);
                });
            }
        }

        function loadPreviewFromHistory(item) {
            switchRightView('preview');
            els.resultImg.src = item.image;
            els.placeholder.classList.add('hidden');
            els.resultImg.classList.remove('hidden', 'scale-95', 'opacity-0');
            els.dlBtn.disabled = false;
            els.dlBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            currentImageId = item.id;
            currentImageData = item;
            showImageActions(true);
        }

        function useCurrentPrompt() {
            if (!currentImageData) return;
            els.prompt.value = currentImageData.prompt;
            els.prompt.classList.add('bg-blue-50', 'dark:bg-blue-900/30');
            setTimeout(() => els.prompt.classList.remove('bg-blue-50', 'dark:bg-blue-900/30'), 500);
        }

        function resetPreview() {
            els.resultImg.src = '';
            els.resultImg.classList.add('hidden', 'scale-95', 'opacity-0');
            els.placeholder.classList.remove('hidden');
            els.dlBtn.disabled = true;
            els.dlBtn.classList.add('opacity-50', 'cursor-not-allowed');
            showImageActions(false);
            currentImageId = null;
        }

        function showImageActions(show) {
            if (show) els.imageActions.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-2');
            else els.imageActions.classList.add('opacity-0', 'pointer-events-none', 'translate-y-2');
        }

        window.downloadZip = function() {
            if (!db) return;
            db.transaction(STORE_NAME, 'readonly').objectStore(STORE_NAME).getAll().onsuccess = (e) => {
                const items = e.target.result;
                if (!items.length) return;
                const zip = new JSZip();
                const folder = zip.folder("novelai_gallery");
                items.forEach((item, idx) => folder.file(`image_${idx}.png`, item.image.split(',')[1], {base64: true}));
                zip.generateAsync({type:"blob"}).then(c => {
                    const a = document.createElement("a");
                    a.href = URL.createObjectURL(c);
                    a.download = `history_${Date.now()}.zip`;
                    a.click();
                });
            };
        };

        function switchRightView(view) {
            currentRightView = view;
            els.viewToggle.dataset.state = view;
            if (view === 'preview') {
                els.viewBtnPreview.classList.add('active'); els.viewBtnHistory.classList.remove('active');
                els.previewArea.classList.remove('hidden'); els.historyArea.classList.add('hidden');
                els.zipBtn.classList.add('hidden'); els.clearBtn.classList.add('hidden'); els.dlBtn.classList.remove('hidden');
            } else {
                els.viewBtnPreview.classList.remove('active'); els.viewBtnHistory.classList.add('active');
                els.previewArea.classList.add('hidden'); els.historyArea.classList.remove('hidden');
                loadGallery();
                els.zipBtn.classList.remove('hidden'); els.clearBtn.classList.remove('hidden'); els.dlBtn.classList.add('hidden');
            }
        }

        // --- 生成与交互 ---
        els.steps.addEventListener('input', e => els.stepsVal.textContent = e.target.value);
        els.scale.addEventListener('input', e => els.scaleVal.textContent = parseFloat(e.target.value).toFixed(1));
        
        function updateModelUI(version) {
            const sw = document.querySelector('.switch-bg');
            if (version === 'v4.5') sw.style.transform = 'translateX(100%)';
            else sw.style.transform = 'translateX(0)';
        }

        function setLoading(loading) {
            els.btn.disabled = loading;
            if (loading) {
                els.btnText.textContent = "生成中...";
                els.btnIcon.classList.add('hidden');
                els.btnLoader.classList.remove('hidden');
                if (!els.resultImg.classList.contains('hidden')) els.resultImg.classList.add('opacity-50', 'blur-sm');
            } else {
                els.btnText.textContent = "免费生成";
                els.btnIcon.classList.remove('hidden');
                els.btnLoader.classList.add('hidden');
                els.resultImg.classList.remove('opacity-50', 'blur-sm');
            }
        }

        els.btn.addEventListener('click', async () => {
            const promptText = els.prompt.value.trim();
            if (!promptText) { els.prompt.focus(); return; }
            const selectedVersion = document.querySelector('input[name="model_version"]:checked').value;
            const [w, h] = els.resolution.value.split(',').map(Number);
            const adminToken = localStorage.getItem('nai_admin_token') || "";
            
            if (currentRightView !== 'preview') switchRightView('preview');
            setLoading(true);
            const startTime = Date.now();
            try {
                const payload = {
                    version: selectedVersion,
                    prompt: promptText,
                    negative_prompt: els.negative.value.trim(),
                    width: w, height: h,
                    steps: parseInt(els.steps.value),
                    scale: parseFloat(els.scale.value),
                    sampler: els.sampler.value
                };
                const res = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-token': adminToken },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok || data.error) throw new Error(data.error || `Server Error: ${res.status}`);
                
                const tempImg = new Image();
                tempImg.src = data.image;
                tempImg.onload = () => {
                    els.resultImg.src = data.image;
                    els.placeholder.classList.add('hidden');
                    els.resultImg.classList.remove('hidden', 'scale-95', 'opacity-0');
                    els.dlBtn.disabled = false;
                    els.dlBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    setLoading(false);
                    saveToHistory(data.image, promptText, selectedVersion);
                };
            } catch (err) {
                console.error(err);
                setLoading(false);
                if (err.message.includes('429')) alert("⚠️ 今日额度已用完");
                else alert("生成失败: " + err.message);
            }
        });

        function downloadImage() {
            if (els.resultImg.src && !els.resultImg.classList.contains('hidden')) {
                const a = document.createElement('a');
                a.href = els.resultImg.src;
                a.download = `novelai-gen-${Date.now()}.png`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }
        }

        // --- 抽屉逻辑 ---
        function toggleDrawer() {
            els.sideDrawer.classList.toggle('drawer-open');
            els.sideDrawer.classList.toggle('drawer-closed');
            els.drawerOverlay.classList.toggle('hidden');
        }
        function switchDrawerTab(tab) {
            if (tab === 'search') {
                els.viewSearch.classList.remove('hidden'); els.viewPreset.classList.add('hidden');
                els.tabSearch.classList.add('active'); els.tabPreset.classList.remove('active');
            } else {
                els.viewSearch.classList.add('hidden'); els.viewPreset.classList.remove('hidden');
                els.tabSearch.classList.remove('active'); els.tabPreset.classList.add('active');
                renderPresets(document.querySelector('input[name="model_version"]:checked').value);
            }
        }
        function openPresets() { if(!els.sideDrawer.classList.contains('drawer-open')) toggleDrawer(); switchDrawerTab('preset'); }

        function enterAdminToken() {
            const cur = localStorage.getItem('nai_admin_token');
            const t = prompt(cur ? "清空以注销" : "输入管理员密码");
            if (t !== null) {
                if (!t.trim()) localStorage.removeItem('nai_admin_token');
                else localStorage.setItem('nai_admin_token', t.trim());
                checkAdminStatus();
            }
        }
        function checkAdminStatus() {
            const t = localStorage.getItem('nai_admin_token');
            if (t) els.adminLockBtn.innerHTML = '<i data-lucide="unlock" class="w-4 h-4 text-green-500"></i>';
            else els.adminLockBtn.innerHTML = '<i data-lucide="lock" class="w-4 h-4 text-gray-300 dark:text-gray-500"></i>';
            lucide.createIcons();
        }
        checkAdminStatus();

        // --- 资源库逻辑 ---
        let tagData = {};
        fetch('all_tags.txt').then(r=>r.json()).then(d=>tagData=d).catch(()=>{});
        
        els.tagSearchBtn.onclick = () => {
            const q = els.tagSearchInput.value.toLowerCase().trim();
            if(!q) return;
            const res = Object.entries(tagData).filter(([e,c])=>e.includes(q)||c.includes(q));
            els.tagResults.innerHTML = '';
            res.forEach(([en,cn]) => {
                const d = document.createElement('div');
                d.className = "p-3 hover:bg-gray-50 dark:hover:bg-slate-800 border-b border-gray-100 dark:border-gray-800 cursor-pointer";
                d.innerHTML = `<div class="text-sm font-medium text-gray-800 dark:text-gray-200">${en}</div><div class="text-xs text-gray-400 dark:text-gray-500">${cn}</div>`;
                d.onclick = () => {
                    els.prompt.value += (els.prompt.value ? ', ' : '') + en;
                };
                els.tagResults.appendChild(d);
            });
        };

        const presetFiles = [
            { id: '1_v3', model: 'v3', name: '未知' }, { id: '2_v3', model: 'v3', name: '未知' },
            { id: '1_v4.5', model: 'v4.5', name: '铃兰' }, { id: '2_v4.5', model: 'v4.5', name: '未知' }
        ];
        function renderPresets(model) {
            const active = "bg-gray-900 text-white dark:bg-slate-100 dark:text-gray-900";
            const inactive = "bg-white text-gray-500 border dark:bg-slate-800 dark:text-gray-400 dark:border-gray-700";
            if(model==='v3') { els.btnPreV3.className=`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${active}`; els.btnPreV4.className=`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${inactive}`; }
            else { els.btnPreV3.className=`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${inactive}`; els.btnPreV4.className=`px-3 py-1 rounded-full text-[10px] font-bold transition-all ${active}`; }
            
            els.presetGrid.innerHTML = '';
            const filtered = presetFiles.filter(p => p.model === model);
            if(filtered.length === 0) { els.presetGrid.innerHTML = '<div class="col-span-2 text-center text-xs text-gray-400">暂无预设</div>'; return; }
            filtered.forEach(p => {
                const d = document.createElement('div');
                d.className = "group cursor-pointer flex flex-col gap-2";
                d.innerHTML = `<div class="aspect-[2/3] w-full rounded-lg bg-gray-100 dark:bg-slate-700 relative overflow-hidden group-hover:shadow-lg transition-all"><img src="presets/${p.id}.png" class="w-full h-full object-cover"></div><span class="text-xs text-center text-gray-500 dark:text-gray-400">${p.name}</span>`;
                d.onclick = async () => {
                    try {
                        const res = await fetch(`presets/${p.id}.txt`);
                        if(res.ok) {
                            els.prompt.value = (await res.text()).trim();
                            if(window.innerWidth < 768) toggleDrawer();
                        }
                    } catch(e){}
                };
                els.presetGrid.appendChild(d);
            });
        }
    </script>
</body>
</html>
