<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>å›¾ç‰‡ç”Ÿæˆå™¨</title>

    <style>
        /* CSS: è´Ÿè´£ç½‘é¡µçš„å¤–è§‚æ ·å¼ */

        /* :root ç”¨äºå®šä¹‰å…¨å±€å˜é‡ï¼Œæ–¹ä¾¿ç»Ÿä¸€ä¿®æ”¹ç½‘ç«™ä¸»é¢˜ */
        :root {
            /* âœ… å¯ä¿®æ”¹: æ›´æ”¹è¿™äº›é¢œè‰²å€¼ï¼Œå¯ä»¥è½»æ¾æ”¹å˜æ•´ä¸ªç½‘é¡µçš„é…è‰²æ–¹æ¡ˆ (æš—é»‘/äº®ç™½ç­‰) */
            --bg-color: #1D1F2B;      /* ä¸»è¦èƒŒæ™¯è‰² */
            --text-color: #747B81;    /* ä¸»è¦æ–‡å­—é¢œè‰² */
            --accent-color: #9CAF93;  /* å¼ºè°ƒè‰²ï¼Œç”¨äºæ ‡é¢˜å’ŒæŒ‰é’® */
            --panel-bg: #404248;      /* é¢æ¿èƒŒæ™¯è‰² */
            --input-bg: #353A49;      /* è¾“å…¥æ¡†èƒŒæ™¯è‰² */
        }

        body {
            /* âœ… å¯ä¿®æ”¹: å¯ä»¥æ›´æ¢æˆä½ å–œæ¬¢çš„å­—ä½“ */
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        /* ä¸»å®¹å™¨æ ·å¼ï¼Œæ§åˆ¶æ•´ä½“å¸ƒå±€ */
        .container {
            display: flex;
            flex-wrap: wrap;
            max-width: 1200px;
            width: 100%;
            gap: 20px; /* âœ… å¯ä¿®æ”¹: å·¦å³ä¸¤ä¸ªé¢æ¿ä¹‹é—´çš„é—´è· */
        }

        /* æ§åˆ¶é¢æ¿å’Œå›¾ç‰‡é¢æ¿çš„é€šç”¨æ ·å¼ */
        .control-panel, .image-panel {
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 12px; /* âœ… å¯ä¿®æ”¹: é¢æ¿çš„åœ†è§’å¤§å° */
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* å·¦å³é¢æ¿çš„å®½åº¦æ¯”ä¾‹ */
        .control-panel { flex: 1; min-width: 350px; }
        .image-panel { flex: 1.5; min-width: 350px; }

        /* æ ‡é¢˜æ ·å¼ */
        h2 { margin-top: 0; color: var(--accent-color); }

        /* è¡¨å•ç»„æ ·å¼ */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }

        /* æ‰€æœ‰è¾“å…¥æ¡†çš„é€šç”¨æ ·å¼ */
        textarea, select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 10px;
            background: var(--input-bg);
            border: 1px solid #373a40;
            border-radius: 6px; /* âœ… å¯ä¿®æ”¹: è¾“å…¥æ¡†çš„åœ†è§’å¤§å° */
            color: var(--text-color);
            box-sizing: border-box;
        }

        /* å¤šè¡Œæ–‡æœ¬æ¡†çš„ç‰¹å®šæ ·å¼ */
        textarea { resize: vertical; height: 80px; font-family: monospace; }
        
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }

        /* æŒ‰é’®æ ·å¼ */
        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        button:hover { filter: brightness(1.1); }
        button:disabled { background-color: #555; cursor: not-allowed; }

        /* æ¨¡æ¿æŒ‰é’®çš„ç‰¹æ®Šæ ·å¼ */
        .template-btn {
            background-color: #343a40;
            font-size: 0.8em;
            padding: 8px 12px;
            margin-right: 5px;
            margin-bottom: 10px;
        }

        /* ç»“æœå›¾ç‰‡æ ·å¼ */
        #resultImage {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none; /* é»˜è®¤éšè—ï¼Œç”ŸæˆæˆåŠŸåæ˜¾ç¤º */
        }

        /* åŠ è½½æç¤ºæ ·å¼ */
        .loading {
            display: none; /* é»˜è®¤éšè—ï¼Œç”Ÿæˆæ—¶æ˜¾ç¤º */
            font-size: 1.2em;
            color: var(--accent-color);
        }

        /* é”™è¯¯ä¿¡æ¯æ ·å¼ */
        .error-msg { color: #7D4D4D; margin-top: 10px; word-break: break-word; }
    </style>
</head>
<body>

<!-- HTML: è´Ÿè´£ç½‘é¡µçš„ç»“æ„å’Œå†…å®¹ -->
<div class="container">
    <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <!-- âœ… å¯ä¿®æ”¹: æ›´æ”¹é¢æ¿çš„æ ‡é¢˜ -->
        <h2>âœ¨é­”æ³•å’’è¯­âœ¨</h2>
        
        <div class="form-group">
            <label>å¿«é€Ÿæ¨¡æ¿</label>
            <div>
                <!-- âœ… å¯ä¿®æ”¹: æ›´æ”¹æŒ‰é’®æ–‡å­—ã€‚æ³¨æ„è¦å’Œä¸‹é¢JSé‡Œçš„æ¨¡æ¿åå¯¹åº” -->
                <button type="button" class="template-btn" onclick="applyTemplate('loli')">ğŸ± çŒ«è€³å¨˜</button>
                <button type="button" class="template-btn" onclick="applyTemplate('luffy')">ğŸ‘’ æµ·è´¼ç‹è·¯é£</button>
                <!-- âœ… å¯ä¿®æ”¹: ä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ–°çš„æ¨¡æ¿æŒ‰é’®ï¼Œæ¯”å¦‚:
                <button type="button" class="template-btn" onclick="applyTemplate('cyberpunk')">ğŸ¤– èµ›åšæœ‹å…‹</button>
                è®°å¾—åœ¨ä¸‹é¢çš„JSé‡Œä¹Ÿæ·»åŠ 'cyberpunk'æ¨¡æ¿æ•°æ®ã€‚
                -->
            </div>
        </div>

        <div class="form-group">
            <label for="prompt">æ­£é¢æç¤ºè¯ (Prompt)</label>
            <!-- âœ… å¯ä¿®æ”¹: æ›´æ”¹é»˜è®¤çš„æç¤ºè¯å†…å®¹ -->
            <textarea id="prompt" placeholder="è¾“å…¥è‹±æ–‡æç¤ºè¯...">1girl, solo, cute, masterpiece, best quality</textarea>
        </div>

        <div class="form-group">
            <label for="negative_prompt">è´Ÿé¢æç¤ºè¯ (Negative Prompt)</label>
            <!-- âœ… å¯ä¿®æ”¹: æ›´æ”¹é»˜è®¤çš„è´Ÿé¢æç¤ºè¯å†…å®¹ -->
            <textarea id="negative_prompt">lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry</textarea>
        </div>

        <div class="row">
            <div class="col form-group">
                <label for="orientation">ç”»å¹…æ–¹å‘</label>
                <select id="orientation">
                    <!-- âœ… å¯ä¿®æ”¹: æ›´æ”¹æˆ–æ·»åŠ æ–°çš„ç”»å¹…é€‰é¡¹ï¼Œä½†éœ€è¦åŒæ­¥ä¿®æ”¹ä¸‹é¢JSé‡Œçš„åˆ†è¾¨ç‡é€»è¾‘ -->
                    <option value="portrait" selected>ç«–å± (832x1216)</option>
                    <option value="landscape">æ¨ªå± (1216x832)</option>
                    <option value="square">æ–¹å½¢ (1024x1024)</option>
                </select>
            </div>
            <div class="col form-group">
                <label for="sampler">é‡‡æ ·å™¨ (Sampler)</label>
                <select id="sampler">
                    <!-- âœ… å¯ä¿®æ”¹: æ ¹æ®ä½ åç«¯æ”¯æŒçš„é‡‡æ ·å™¨ï¼Œæ·»åŠ æˆ–åˆ é™¤é€‰é¡¹ -->
                    <option value="k_euler">Euler</option>
                    <option value="k_euler_ancestral" selected>Euler Ancestral</option>
                    <option value="k_dpmpp_2m">DPM++ 2M</option>
                    <option value="k_dpmpp_2s_ancestral">DPM++ 2S Ancestral</option>
                    <option value="k_dpmpp_sde">DPM++ SDE</option>
                    <option value="ddim_v3">DDIM V3</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="col form-group">
                <label for="steps">æ­¥æ•° (Steps): <span id="stepsVal">28</span></label>
                <!-- âœ… å¯ä¿®æ”¹: æ›´æ”¹æ­¥æ•°çš„èŒƒå›´(min, max)å’Œé»˜è®¤å€¼(value) -->
                <input type="range" id="steps" min="1" max="28" value="28" oninput="document.getElementById('stepsVal').innerText = this.value">
            </div>
            <div class="col form-group">
                <label for="scale">æç¤ºè¯ç›¸å…³æ€§ (CFG): <span id="scaleVal">5.0</span></label>
                <!-- âœ… å¯ä¿®æ”¹: æ›´æ”¹CFGçš„èŒƒå›´(min, max, step)å’Œé»˜è®¤å€¼(value) -->
                <input type="range" id="scale" min="1.1" max="10.0" step="0.1" value="5.0" oninput="document.getElementById('scaleVal').innerText = this.value">
            </div>
        </div>

        <!-- âœ… å¯ä¿®æ”¹: æ›´æ”¹ç”ŸæˆæŒ‰é’®çš„æ–‡å­—å’Œå›¾æ ‡ -->
        <button id="generateBtn" onclick="generateImage()" style="width: 100%; margin-top: 10px; font-size: 1.1em;">âœ¨ å¼€å§‹ç”Ÿæˆ</button>
        <div id="errorMsg" class="error-msg"></div>
    </div>

    <!-- å³ä¾§å›¾ç‰‡å±•ç¤º -->
    <div class="image-panel">
        <!-- âœ… å¯ä¿®æ”¹: æ›´æ”¹æ­£åœ¨ç”Ÿæˆæ—¶çš„æç¤ºæ–‡å­— -->
        <div id="loading" class="loading">ğŸš€ å°‘å¥³ç¥ˆç¥·ä¸­... (æ­£åœ¨ç”Ÿæˆ)</div>
        <img id="resultImage" alt="Generated Image">
    </div>
</div>

<!-- JavaScript: è´Ÿè´£ç½‘é¡µçš„äº¤äº’å’ŒåŠŸèƒ½ -->
<script>
    const templates = {
        loli: {
            prompt: "1girl, loli, cat ears, cute, white hair, blue eyes, frills, dress, masterpiece, best quality, cinematic lighting",
            orientation: "portrait"
        },
        luffy: {
            prompt: "monkey d. luffy, one piece, male focus, straw hat, red vest, scar under eye, smiling, masterpiece, best quality, intense shadows",
            orientation: "landscape"
        }
    };

    function applyTemplate(type) {
        const t = templates[type];
        if (t) {
            document.getElementById('prompt').value = t.prompt;
            document.getElementById('orientation').value = t.orientation;
        }
    }

    async function generateImage() {
        const btn = document.getElementById('generateBtn');
        const loading = document.getElementById('loading');
        const img = document.getElementById('resultImage');
        const errorMsg = document.getElementById('errorMsg');

        btn.disabled = true;
        btn.innerText = "ç”Ÿæˆä¸­...";
        loading.style.display = "block";
        img.style.display = "none";
        errorMsg.innerText = "";

        let width, height;
        const ori = document.getElementById('orientation').value;
        if (ori === 'portrait') { width = 832; height = 1216; }
        else if (ori === 'landscape') { width = 1216; height = 832; }
        else { width = 1024; height = 1024; }

        const payload = {
            prompt: document.getElementById('prompt').value,
            negative_prompt: document.getElementById('negative_prompt').value,
            width: width,
            height: height,
            steps: parseInt(document.getElementById('steps').value),
            sampler: document.getElementById('sampler').value,
            scale: parseFloat(document.getElementById('scale').value)
        };

        try {
            const response = await fetch('/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (response.ok) {
                img.src = data.image;
                img.style.display = "block";
            } else {
                // --- è¿™æ˜¯è¢«ä¿®æ”¹çš„éƒ¨åˆ† ---
                // ç°åœ¨å®ƒä¼šæ˜¾ç¤ºå®Œæ•´çš„é”™è¯¯å¯¹è±¡ï¼Œè€Œä¸ä»…ä»…æ˜¯ data.error
                let fullError = data.error || response.statusText;
                if (data.details) {
                    // ä½¿ç”¨ JSON.stringify æ¥æ ¼å¼åŒ– details å¯¹è±¡ï¼Œä½¿å…¶æ›´æ˜“è¯»
                    fullError += "\n\nè¯¦ç»†ä¿¡æ¯:\n" + JSON.stringify(data.details, null, 2);
                }
                errorMsg.innerText = "ç”Ÿæˆå¤±è´¥: " + fullError;
                // --- ä¿®æ”¹ç»“æŸ ---
            }
        } catch (e) {
            errorMsg.innerText = "ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¼€å¯: " + e.message;
        } finally {
            btn.disabled = false;
            btn.innerText = "âœ¨ å¼€å§‹ç”Ÿæˆ";
            loading.style.display = "none";
        }
    }
</script>
</body>
</html>
