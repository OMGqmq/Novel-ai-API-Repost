<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovelAI Opus Free</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        /* --- åŠ¨æ€èƒŒæ™¯ä¸åŸºç¡€è®¾å®š --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            background-image: 
                radial-gradient(at 0% 0%, rgba(229, 231, 235, 0.5) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(209, 213, 219, 0.5) 0px, transparent 50%),
                linear-gradient(to bottom right, #f9fafb, #f3f4f6);
            background-size: 100% 100%;
            background-attachment: fixed;
        }

        body::before {
            content: "";
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events: none; z-index: 50;
        }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-right: 1px solid rgba(229, 231, 235, 0.6);
        }

        /* ä¾§è¾¹æ åŠ¨ç”» */
        .drawer { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .drawer-open { transform: translateX(0); box-shadow: 10px 0 30px -10px rgba(0,0,0,0.05); }
        .drawer-closed { transform: translateX(-100%); }

        /* é€‰é¡¹å¡ */
        .tab-btn { position: relative; color: #9ca3af; transition: color 0.3s; }
        .tab-btn.active { color: #1f2937; font-weight: 600; }
        .tab-btn.active::after { 
            content: ''; position: absolute; bottom: 0; left: 50%; width: 40%; height: 2px;
            background: #1f2937; transform: translateX(-50%); 
        }

        /* åŠ è½½åŠ¨ç”» */
        .loader {
            width: 18px; height: 18px; border: 2px solid #fff;
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; animation: rotation 0.8s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* é¡¶éƒ¨åˆ‡æ¢å¼€å…³ (Segmented Control) */
        .view-toggle {
            background: rgba(243, 244, 246, 0.8);
            border: 1px solid rgba(229, 231, 235, 0.8);
            border-radius: 9999px;
            padding: 4px;
            display: flex;
            position: relative;
        }
        .view-toggle button {
            position: relative;
            z-index: 2;
            padding: 4px 16px;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            transition: color 0.3s;
            border-radius: 9999px;
        }
        .view-toggle button.active { color: #111827; }
        .view-toggle-bg {
            position: absolute;
            top: 4px; bottom: 4px; left: 4px; width: calc(50% - 4px);
            background: white; border-radius: 9999px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }
        /* çŠ¶æ€æ§åˆ¶ */
        .view-toggle[data-state="history"] .view-toggle-bg { transform: translateX(100%); }

        /* å†å²ç½‘æ ¼é¡¹ */
        .gallery-item { 
            position: relative; overflow: hidden; border-radius: 12px; cursor: pointer; 
            border: 1px solid #f3f4f6; transition: all 0.2s;
        }
        .gallery-item:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.05); border-color: #e5e7eb; }
        .gallery-overlay {
            position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
            opacity: 0; transition: opacity 0.2s; display: flex; align-items: flex-end; justify-content: space-between; padding: 8px;
        }
        .gallery-item:hover .gallery-overlay { opacity: 1; }

        /* è¾“å…¥æ¡†æ ·å¼ */
        .input-group:focus-within { transform: translateY(-1px); }
        
        /* æ¨¡å‹å¼€å…³æ ·å¼ */
        .model-switch-label { cursor: pointer; transition: all 0.4s; position: relative; z-index: 1; }
        input[type="radio"]:checked + .model-switch-label { color: #111827; }
        .switch-bg {
            position: absolute; height: calc(100% - 8px); width: calc(50% - 6px);
            top: 4px; left: 4px; background: white; border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 0;
        }
        #model-v4:checked ~ .switch-bg { transform: translateX(calc(100% + 4px)); }
    </style>
</head>

<body class="text-gray-600 min-h-screen md:h-screen landscape:h-screen flex flex-col md:flex-row landscape:flex-row md:overflow-hidden landscape:overflow-hidden">

    <!-- å·¦ä¾§æŠ½å±‰ï¼šèµ„æºåº“ (æœè¯/é¢„è®¾) -->
    <div id="sideDrawer" class="fixed inset-y-0 left-0 w-80 bg-white/95 backdrop-blur-xl z-50 drawer drawer-closed flex flex-col border-r border-gray-100/50">
        <div class="flex items-center justify-between p-5 border-b border-gray-100">
            <h2 class="font-semibold text-gray-800 flex items-center gap-2">
                <i data-lucide="library" class="w-4 h-4 text-gray-400"></i> èµ„æºåº“
            </h2>
            <button onclick="toggleDrawer()" class="p-1.5 hover:bg-gray-100 rounded-lg text-gray-400">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="flex border-b border-gray-100 bg-white/50">
            <button onclick="switchDrawerTab('search')" id="tab-search" class="tab-btn active flex-1 py-3 text-xs flex justify-center items-center gap-1.5">
                <i data-lucide="search" class="w-3 h-3"></i> æœè¯
            </button>
            <button onclick="switchDrawerTab('preset')" id="tab-preset" class="tab-btn flex-1 py-3 text-xs flex justify-center items-center gap-1.5">
                <i data-lucide="grid" class="w-3 h-3"></i> é¢„è®¾
            </button>
        </div>
        <!-- æœç´¢å†…å®¹ -->
        <div id="view-search" class="flex flex-col flex-1 overflow-hidden">
            <div class="p-5 border-b border-gray-100">
                <div class="flex gap-2 relative group">
                    <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                    <input type="text" id="tagSearchInput" placeholder="æœç´¢å…³é”®è¯..." class="w-full pl-9 pr-2 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm outline-none focus:border-gray-300">
                    <button id="tagSearchBtn" class="px-4 py-2 bg-gray-900 text-white text-xs font-medium rounded-lg shadow-md active:scale-95">æœç´¢</button>
                </div>
            </div>
            <div id="tagResults" class="flex-1 overflow-y-auto p-2 space-y-1">
                <div class="text-center mt-12 text-xs text-gray-300">è¾“å…¥å…³é”®è¯å¼€å§‹æ¢ç´¢</div>
            </div>
        </div>
        <!-- é¢„è®¾å†…å®¹ -->
        <div id="view-preset" class="flex flex-col flex-1 overflow-hidden hidden">
            <div class="px-5 py-3 border-b border-gray-100 flex gap-2 justify-center">
                <button onclick="renderPresets('v3')" id="btn-pre-v3" class="px-4 py-1.5 rounded-full text-[10px] font-bold border transition-all">V3</button>
                <button onclick="renderPresets('v4.5')" id="btn-pre-v4" class="px-4 py-1.5 rounded-full text-[10px] font-bold border transition-all">V4.5</button>
            </div>
            <div id="presetGrid" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 gap-4 content-start"></div>
        </div>
    </div>
    <div id="drawerOverlay" onclick="toggleDrawer()" class="fixed inset-0 bg-gray-900/10 backdrop-blur-[2px] z-40 hidden transition-opacity duration-300"></div>

    <!-- ä¸­é—´ï¼šæ§åˆ¶é¢æ¿ -->
    <div class="w-full md:w-[400px] landscape:w-[360px] glass-panel flex flex-col z-20 shadow-[20px_0_40px_-10px_rgba(0,0,0,0.03)] relative order-2 md:order-1 landscape:order-1 md:h-full landscape:h-full">
        <!-- æ ‡é¢˜ -->
        <div class="p-6 border-b border-gray-100 sticky top-0 bg-white/80 backdrop-blur-md z-30">
            <div class="flex items-center justify-between mb-5">
                <div class="flex items-center gap-3">
                    <button onclick="toggleDrawer()" class="p-2 -ml-2 hover:bg-white hover:shadow-sm rounded-xl transition-all text-gray-500">
                        <i data-lucide="menu" class="w-5 h-5"></i>
                    </button>
                    <h1 class="text-base font-semibold text-gray-800 flex items-center gap-2">
                        Opus Free <span class="text-[9px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded border border-gray-200">0 ANLAS</span>
                    </h1>
                </div>
                <button onclick="enterAdminToken()" id="adminLockBtn" class="p-1.5 rounded-full hover:bg-gray-100 text-gray-400">
                    <i data-lucide="lock" class="w-4 h-4"></i>
                </button>
            </div>
            <!-- æ¨¡å‹åˆ‡æ¢ -->
            <div class="relative bg-gray-100/80 p-1 rounded-lg flex border border-gray-200/50">
                <input type="radio" name="model_version" id="model-v3" value="v3" class="hidden" checked onchange="updateModelUI('v3')">
                <input type="radio" name="model_version" id="model-v4" value="v4.5" class="hidden" onchange="updateModelUI('v4.5')">
                <div class="switch-bg"></div>
                <label for="model-v3" class="model-switch-label flex-1 text-center py-2 text-xs font-medium text-gray-500 hover:text-gray-600">NAI V3</label>
                <label for="model-v4" class="model-switch-label flex-1 text-center py-2 text-xs font-medium text-gray-500 hover:text-gray-600 flex items-center justify-center gap-1">NAI V4.5 <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span></label>
            </div>
        </div>

        <!-- æ»šåŠ¨è¡¨å• -->
        <div class="flex-none md:flex-1 landscape:flex-1 md:overflow-y-auto landscape:overflow-y-auto p-6 space-y-6 pb-28 md:pb-6 landscape:pb-6 custom-scroll">
            <div class="input-group space-y-2">
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest flex justify-between px-1">
                    <span>æç¤ºè¯</span>
                    <span onclick="openPresets()" class="cursor-pointer text-gray-400 hover:text-gray-800 flex items-center gap-1"><i data-lucide="layout-grid" class="w-3 h-3"></i> é¢„è®¾</span>
                </label>
                <textarea id="prompt" rows="4" class="w-full bg-white border border-gray-200 text-gray-800 text-sm rounded-xl focus:border-gray-400 outline-none p-3.5 shadow-sm" placeholder="æè¿°ä½ æƒ³è±¡ä¸­çš„ç”»é¢..."></textarea>
            </div>
            <div class="input-group space-y-2">
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-1">è´Ÿå‘æç¤ºè¯</label>
                <textarea id="negativePrompt" rows="2" class="w-full bg-white border border-gray-200 text-gray-800 text-sm rounded-xl focus:border-gray-400 outline-none p-3.5 shadow-sm">lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry</textarea>
            </div>
            <div class="input-group space-y-2">
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-1">ç”»å¹…å¤§å°</label>
                <div class="relative">
                    <select id="resolution" class="w-full bg-white border border-gray-200 text-gray-800 text-xs font-medium rounded-xl p-3.5 outline-none focus:border-gray-400 cursor-pointer shadow-sm appearance-none">
                        <option value="832,1216" selected>Portrait (832 x 1216)</option>
                        <option value="1216,832">Landscape (1216 x 832)</option>
                        <option value="1024,1024">Square (1024 x 1024)</option>
                        <option value="832,832">Small Square (832 x 832)</option>
                        <option value="512,768">Speed Portrait (512 x 768)</option>
                    </select>
                    <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-4 h-4 text-gray-400 pointer-events-none"></i>
                </div>
            </div>
            <div class="space-y-5 pt-2 border-t border-gray-100/50">
                <div class="space-y-3">
                    <div class="flex justify-between text-xs px-1"><label class="font-medium text-gray-500">æ­¥æ•°</label><span id="stepsValue" class="font-mono font-bold bg-gray-100 px-1.5 rounded">28</span></div>
                    <input type="range" id="steps" min="1" max="28" value="28" class="w-full h-1.5 bg-gray-200 rounded-full appearance-none cursor-pointer accent-gray-800">
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between text-xs px-1"><label class="font-medium text-gray-500">ç›¸å…³æ€§</label><span id="scaleValue" class="font-mono font-bold bg-gray-100 px-1.5 rounded">5.0</span></div>
                    <input type="range" id="scale" min="1" max="20" value="5" step="0.5" class="w-full h-1.5 bg-gray-200 rounded-full appearance-none cursor-pointer accent-gray-800">
                </div>
            </div>
            <div class="input-group space-y-2">
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-1">é‡‡æ ·å™¨</label>
                <div class="relative">
                    <select id="sampler" class="w-full bg-white border border-gray-200 text-gray-800 text-xs font-medium rounded-xl p-3.5 outline-none focus:border-gray-400 cursor-pointer shadow-sm appearance-none">
                        <option value="k_euler" selected>Euler (æ ‡å‡†)</option>
                        <option value="k_euler_ancestral">Euler Ancestral</option>
                        <option value="k_dpmpp_2m">DPM++ 2M</option>
                        <option value="k_dpmpp_2s_ancestral">DPM++ 2S Ancestral</option>
                        <option value="k_dpmpp_sde">DPM++ SDE</option>
                        <option value="ddim_v3">DDIM</option>
                    </select>
                    <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-4 h-4 text-gray-400 pointer-events-none"></i>
                </div>
            </div>
        </div>

        <div class="p-6 border-t border-gray-100 bg-white/80 backdrop-blur-md z-20 fixed bottom-0 left-0 right-0 md:sticky landscape:sticky md:bottom-0 landscape:bottom-0">
            <button id="generateBtn" class="w-full group flex items-center justify-center gap-2 py-4 px-4 bg-gray-900 hover:bg-black text-white text-sm font-semibold rounded-xl transition-all shadow-xl shadow-gray-200 active:scale-[0.99]">
                <span id="btnIcon"><i data-lucide="sparkles" class="w-4 h-4 text-yellow-300"></i></span>
                <span id="btnLoader" class="hidden"><span class="loader"></span></span>
                <span id="btnText">å…è´¹ç”Ÿæˆ</span>
            </button>
        </div>
    </div>

    <!-- å³ä¾§ï¼šé¢„è§ˆä¸å›¾åº“ -->
    <div class="relative flex flex-col h-[38vh] md:h-full landscape:h-full overflow-hidden order-1 md:order-2 landscape:order-2 border-b md:border-b-0 landscape:border-b-0 landscape:border-l border-gray-200 flex-shrink-0 flex-1 bg-white/50">
        
        <!-- é¡¶éƒ¨å·¥å…·æ  (åˆ‡æ¢ä¸ä¸‹è½½) -->
        <div class="absolute top-0 left-0 right-0 h-16 flex items-center justify-between px-6 z-20 pointer-events-none">
            <!-- å·¦ä¾§ï¼šè§†å›¾åˆ‡æ¢ -->
            <div class="pointer-events-auto">
                <div class="view-toggle" id="viewToggle" data-state="preview">
                    <div class="view-toggle-bg"></div>
                    <button onclick="switchRightView('preview')" id="viewBtnPreview" class="active">å½“å‰ç”»å¸ƒ</button>
                    <button onclick="switchRightView('history')" id="viewBtnHistory">å†å²å›¾åº“</button>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šæ“ä½œæŒ‰é’® -->
            <div class="pointer-events-auto flex gap-2" id="topActionBtns">
                <button onclick="downloadZip()" id="zipBtn" class="hidden p-2.5 bg-white rounded-xl shadow-sm border border-gray-200 text-gray-500 hover:text-gray-900 transition-all hover:scale-105" title="æ‰“åŒ…ä¸‹è½½ ZIP">
                    <i data-lucide="archive" class="w-4 h-4"></i>
                </button>
                <button onclick="downloadImage()" id="dlBtn" class="p-2.5 bg-white rounded-xl shadow-sm border border-gray-200 text-gray-500 hover:text-gray-900 transition-all opacity-50 cursor-not-allowed hover:scale-105" disabled title="ä¸‹è½½å½“å‰å›¾ç‰‡">
                    <i data-lucide="download" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <!-- è§†å›¾ 1: å•å›¾é¢„è§ˆ -->
        <div id="previewArea" class="flex-1 flex flex-col items-center justify-center p-6 md:p-12 overflow-hidden relative transition-opacity duration-300">
            <!-- è£…é¥°ç½‘æ ¼ -->
            <div class="absolute inset-0 opacity-[0.02]" style="background-image: radial-gradient(#000 1px, transparent 1px); background-size: 32px 32px;"></div>
            
            <div id="placeholder" class="text-center transition-all duration-500">
                <div class="w-24 h-24 bg-white rounded-3xl shadow-[0_20px_40px_-10px_rgba(0,0,0,0.08)] border border-gray-100 flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="image" class="w-8 h-8 text-gray-300"></i>
                </div>
                <p class="text-gray-400 text-sm font-light">Opus ç®—åŠ›å°±ç»ª</p>
                <div id="modelBadge" class="mt-3 text-[10px] font-mono text-gray-400 bg-gray-100 px-3 py-1 rounded-full inline-block border border-gray-200">V3 MODE</div>
            </div>

            <img id="resultImage" class="hidden w-full h-full object-contain shadow-2xl rounded-xl border-4 border-white transition-all duration-700 scale-95 opacity-0 cursor-pointer" onclick="openImageModal(this.src)">
            
            <!-- å¿«æ·æ“ä½œæ  (ä»…åœ¨æœ‰å›¾æ—¶æ˜¾ç¤º) -->
            <div id="imageActions" class="absolute bottom-6 flex gap-3 opacity-0 transition-opacity pointer-events-none transform translate-y-4">
                <button onclick="useCurrentPrompt()" class="pointer-events-auto flex items-center gap-2 px-4 py-2 bg-white/90 backdrop-blur text-xs font-medium text-gray-700 rounded-full shadow-lg border border-gray-100 hover:bg-white hover:scale-105 transition-all">
                    <i data-lucide="pen-tool" class="w-3 h-3"></i> ä½¿ç”¨æ­¤æç¤ºè¯
                </button>
                <button onclick="deleteCurrentImage()" class="pointer-events-auto flex items-center gap-2 px-4 py-2 bg-white/90 backdrop-blur text-xs font-medium text-red-500 rounded-full shadow-lg border border-gray-100 hover:bg-white hover:scale-105 transition-all">
                    <i data-lucide="trash-2" class="w-3 h-3"></i> åˆ é™¤
                </button>
            </div>
        </div>

        <!-- è§†å›¾ 2: å†å²å›¾åº“ -->
        <div id="historyArea" class="flex-1 hidden overflow-y-auto p-6 pt-20 custom-scroll bg-gray-50/50">
            <div id="galleryGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 content-start">
                <!-- JS æ¸²æŸ“ -->
            </div>
            <div id="emptyGallery" class="hidden h-full flex flex-col items-center justify-center text-gray-400">
                <i data-lucide="ghost" class="w-8 h-8 mb-2 opacity-50"></i>
                <span class="text-xs">æš‚æ— å†å²è®°å½•</span>
            </div>
        </div>

        <!-- åº•éƒ¨çŠ¶æ€æ  -->
        <div class="h-10 bg-white/50 backdrop-blur-sm border-t border-gray-200/50 flex items-center justify-between px-6 text-[10px] text-gray-400 uppercase tracking-wider font-mono z-20">
            <span id="statusText">System Ready</span>
            <span id="metaInfo"></span>
        </div>
    </div>
    
    <div class="h-24 md:hidden landscape:hidden order-3 w-full bg-white"></div>

    <script>
        lucide.createIcons();
        
        // --- æ ¸å¿ƒå˜é‡ ---
        let currentRightView = 'preview'; // 'preview' or 'history'
        let currentImageId = null; // å½“å‰é¢„è§ˆå›¾ç‰‡çš„ ID (æ•°æ®åº“ID)
        let currentImageData = null; // å½“å‰é¢„è§ˆå›¾ç‰‡çš„å®Œæ•´æ•°æ®

        const els = {
            // å·¦ä¾§
            prompt: document.getElementById('prompt'),
            negative: document.getElementById('negativePrompt'),
            resolution: document.getElementById('resolution'),
            steps: document.getElementById('steps'),
            scale: document.getElementById('scale'),
            sampler: document.getElementById('sampler'),
            btn: document.getElementById('generateBtn'),
            btnText: document.getElementById('btnText'),
            btnIcon: document.getElementById('btnIcon'),
            btnLoader: document.getElementById('btnLoader'),
            adminLockBtn: document.getElementById('adminLockBtn'),
            
            // æŠ½å±‰
            sideDrawer: document.getElementById('sideDrawer'),
            drawerOverlay: document.getElementById('drawerOverlay'),
            tagSearchInput: document.getElementById('tagSearchInput'),
            tagResults: document.getElementById('tagResults'),
            tagSearchBtn: document.getElementById('tagSearchBtn'),
            viewSearch: document.getElementById('view-search'),
            viewPreset: document.getElementById('view-preset'),
            tabSearch: document.getElementById('tab-search'),
            tabPreset: document.getElementById('tab-preset'),
            presetGrid: document.getElementById('presetGrid'),
            btnPreV3: document.getElementById('btn-pre-v3'),
            btnPreV4: document.getElementById('btn-pre-v4'),

            // å³ä¾§
            previewArea: document.getElementById('previewArea'),
            historyArea: document.getElementById('historyArea'),
            viewToggle: document.getElementById('viewToggle'),
            viewBtnPreview: document.getElementById('viewBtnPreview'),
            viewBtnHistory: document.getElementById('viewBtnHistory'),
            resultImg: document.getElementById('resultImage'),
            placeholder: document.getElementById('placeholder'),
            status: document.getElementById('statusText'),
            dlBtn: document.getElementById('dlBtn'),
            zipBtn: document.getElementById('zipBtn'),
            galleryGrid: document.getElementById('galleryGrid'),
            emptyGallery: document.getElementById('emptyGallery'),
            imageActions: document.getElementById('imageActions'),
            stepsVal: document.getElementById('stepsValue'),
            scaleVal: document.getElementById('scaleValue'),
            modelBadge: document.getElementById('modelBadge')
        };

        // ================= ğŸ“š æ•°æ®åº“ (IndexedDB) =================
        const DB_NAME = 'nai_opus_db';
        const STORE_NAME = 'history';
        let db;

        const initDB = () => {
            const request = indexedDB.open(DB_NAME, 1);
            request.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                }
            };
            request.onsuccess = e => { db = e.target.result; loadGallery(); };
        };
        initDB();

        function saveToHistory(imgBase64, prompt, model) {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const item = { image: imgBase64, prompt, model, date: Date.now() };
            const req = tx.objectStore(STORE_NAME).add(item);
            req.onsuccess = (e) => {
                // ä¿å­˜æˆåŠŸåï¼Œæ›´æ–°å½“å‰å›¾ç‰‡IDï¼Œä»¥ä¾¿åˆ é™¤
                currentImageId = e.target.result;
                currentImageData = item;
                showImageActions(true);
                loadGallery(); // åˆ·æ–°å›¾åº“
            };
        }

        function deleteCurrentImage() {
            if (!currentImageId || !db) return;
            if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ")) return;
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).delete(currentImageId);
            tx.oncomplete = () => {
                resetPreview(); // æ¸…ç©ºé¢„è§ˆ
                loadGallery();  // åˆ·æ–°å›¾åº“
                alert("å·²åˆ é™¤");
            };
        }

        function loadGallery() {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, 'readonly');
            const req = tx.objectStore(STORE_NAME).getAll();
            req.onsuccess = () => {
                const items = req.result.reverse(); // æœ€æ–°åœ¨å‰
                renderGallery(items);
            };
        }

        function renderGallery(items) {
            els.galleryGrid.innerHTML = '';
            if (items.length === 0) {
                els.emptyGallery.classList.remove('hidden');
                els.zipBtn.classList.add('hidden');
            } else {
                els.emptyGallery.classList.add('hidden');
                els.zipBtn.classList.remove('hidden'); // æ˜¾ç¤ºæ‰“åŒ…æŒ‰é’®
                
                items.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'gallery-item aspect-[2/3] bg-gray-100 relative group';
                    el.innerHTML = `
                        <img src="${item.image}" class="w-full h-full object-cover">
                        <div class="gallery-overlay">
                            <span class="text-[9px] text-white/80 font-mono">${new Date(item.date).toLocaleTimeString()}</span>
                        </div>
                    `;
                    el.onclick = () => loadPreviewFromHistory(item);
                    els.galleryGrid.appendChild(el);
                });
            }
        }

        function loadPreviewFromHistory(item) {
            // åˆ‡æ¢åˆ°é¢„è§ˆè§†å›¾
            switchRightView('preview');
            // å¡«å……æ•°æ®
            els.resultImg.src = item.image;
            els.placeholder.classList.add('hidden');
            els.resultImg.classList.remove('hidden', 'scale-95', 'opacity-0');
            
            // å¯ç”¨æŒ‰é’®
            els.dlBtn.disabled = false;
            els.dlBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            
            // è®°å½•å½“å‰çŠ¶æ€
            currentImageId = item.id;
            currentImageData = item;
            showImageActions(true);
        }

        function useCurrentPrompt() {
            if (!currentImageData) return;
            els.prompt.value = currentImageData.prompt;
            // è‡ªåŠ¨åˆ‡æ¢æ¨¡å‹
            const model = currentImageData.model || 'v3';
            const input = document.querySelector(`input[name="model_version"][value="${model}"]`);
            if (input && !input.checked) {
                input.checked = true;
                updateModelUI(model);
            }
            // åé¦ˆåŠ¨ç”»
            els.prompt.classList.add('bg-blue-50');
            setTimeout(() => els.prompt.classList.remove('bg-blue-50'), 500);
        }

        function resetPreview() {
            els.resultImg.src = '';
            els.resultImg.classList.add('hidden', 'scale-95', 'opacity-0');
            els.placeholder.classList.remove('hidden');
            els.dlBtn.disabled = true;
            els.dlBtn.classList.add('opacity-50', 'cursor-not-allowed');
            showImageActions(false);
            currentImageId = null;
            currentImageData = null;
        }

        function showImageActions(show) {
            if (show) {
                els.imageActions.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-4');
            } else {
                els.imageActions.classList.add('opacity-0', 'pointer-events-none', 'translate-y-4');
            }
        }

        // æ‰“åŒ…ä¸‹è½½ ZIP
        window.downloadZip = function() {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, 'readonly');
            const req = tx.objectStore(STORE_NAME).getAll();
            
            req.onsuccess = () => {
                const items = req.result;
                if (items.length === 0) return;

                const zip = new JSZip();
                const folder = zip.folder("novelai_gallery");
                
                items.forEach((item, idx) => {
                    const data = item.image.split(',')[1];
                    folder.file(`image_${item.date}_${idx}.png`, data, {base64: true});
                });

                zip.generateAsync({type:"blob"}).then(content => {
                    const a = document.createElement("a");
                    a.href = URL.createObjectURL(content);
                    a.download = `novelai_gallery_${Date.now()}.zip`;
                    a.click();
                });
            };
        };

        // ================= ğŸ“º è§†å›¾åˆ‡æ¢ =================
        function switchRightView(view) {
            currentRightView = view;
            els.viewToggle.dataset.state = view;
            
            if (view === 'preview') {
                els.viewBtnPreview.classList.add('active');
                els.viewBtnHistory.classList.remove('active');
                els.previewArea.classList.remove('hidden');
                els.historyArea.classList.add('hidden');
                // æŒ‰é’®çŠ¶æ€
                els.zipBtn.classList.add('hidden');
                els.dlBtn.classList.remove('hidden');
            } else {
                els.viewBtnPreview.classList.remove('active');
                els.viewBtnHistory.classList.add('active');
                els.previewArea.classList.add('hidden');
                els.historyArea.classList.remove('hidden');
                loadGallery(); // æ¯æ¬¡è¿›å…¥éƒ½åˆ·æ–°
                // æŒ‰é’®çŠ¶æ€
                els.zipBtn.classList.remove('hidden');
                els.dlBtn.classList.add('hidden');
            }
        }

        // ================= ğŸ¨ ç”Ÿæˆé€»è¾‘ =================
        els.steps.addEventListener('input', e => els.stepsVal.textContent = e.target.value);
        els.scale.addEventListener('input', e => els.scaleVal.textContent = parseFloat(e.target.value).toFixed(1));
        
        function updateModelUI(version) {
            if (version === 'v4.5') {
                els.modelBadge.textContent = "V4.5 MODE";
                els.modelBadge.className = "mt-3 text-[10px] font-mono text-blue-500 bg-blue-50 px-3 py-1 rounded-full inline-block border border-blue-100";
            } else {
                els.modelBadge.textContent = "V3 MODE";
                els.modelBadge.className = "mt-3 text-[10px] font-mono text-gray-400 bg-gray-100 px-3 py-1 rounded-full inline-block border border-gray-200";
            }
        }

        function setLoading(loading) {
            els.btn.disabled = loading;
            if (loading) {
                els.btnText.textContent = "ç”Ÿæˆä¸­...";
                els.btnIcon.classList.add('hidden');
                els.btnLoader.classList.remove('hidden');
                els.status.textContent = "Processing...";
                // æ¨¡ç³Šæ—§å›¾
                if (!els.resultImg.classList.contains('hidden')) {
                    els.resultImg.classList.add('opacity-50', 'blur-sm');
                }
            } else {
                els.btnText.textContent = "å…è´¹ç”Ÿæˆ";
                els.btnIcon.classList.remove('hidden');
                els.btnLoader.classList.add('hidden');
                els.resultImg.classList.remove('opacity-50', 'blur-sm');
            }
        }

        els.btn.addEventListener('click', async () => {
            const promptText = els.prompt.value.trim();
            if (!promptText) { els.prompt.focus(); return; }
            const selectedVersion = document.querySelector('input[name="model_version"]:checked').value;
            const [w, h] = els.resolution.value.split(',').map(Number);
            const adminToken = localStorage.getItem('nai_admin_token') || "";
            
            // å¼ºåˆ¶åˆ‡å›é¢„è§ˆè§†å›¾
            if (currentRightView !== 'preview') switchRightView('preview');

            setLoading(true);
            const startTime = Date.now();
            
            try {
                const payload = {
                    version: selectedVersion,
                    prompt: promptText,
                    negative_prompt: els.negative.value.trim(),
                    width: w, height: h,
                    steps: parseInt(els.steps.value),
                    scale: parseFloat(els.scale.value),
                    sampler: els.sampler.value
                };
                const res = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-token': adminToken },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok || data.error) throw new Error(data.error || `Server Error: ${res.status}`);
                
                const tempImg = new Image();
                tempImg.src = data.image;
                tempImg.onload = () => {
                    els.resultImg.src = data.image;
                    els.placeholder.classList.add('hidden');
                    els.resultImg.classList.remove('hidden', 'scale-95', 'opacity-0');
                    els.dlBtn.disabled = false;
                    els.dlBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    const time = ((Date.now() - startTime) / 1000).toFixed(1);
                    const roleInfo = data.user_role ? ` â€¢ ${data.user_role}` : "";
                    els.status.textContent = `Completed in ${time}s${roleInfo}`;
                    setLoading(false);
                    
                    // ä¿å­˜
                    saveToHistory(data.image, promptText, selectedVersion);
                };
            } catch (err) {
                console.error(err);
                setLoading(false);
                if (err.message.includes('429')) alert("âš ï¸ æç¤ºï¼šä»Šæ—¥é¢åº¦å·²ç”¨å®Œã€‚");
                else alert("ç”Ÿæˆå¤±è´¥: " + err.message);
                els.status.textContent = "Error";
            }
        });

        function downloadImage() {
            if (els.resultImg.src && !els.resultImg.classList.contains('hidden')) {
                const a = document.createElement('a');
                a.href = els.resultImg.src;
                a.download = `novelai-gen-${Date.now()}.png`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }
        }

        // ================= ä¾§è¾¹æ é€»è¾‘ (æœè¯/é¢„è®¾) =================
        function toggleDrawer() {
            els.sideDrawer.classList.toggle('drawer-open');
            els.sideDrawer.classList.toggle('drawer-closed');
            els.drawerOverlay.classList.toggle('hidden');
        }
        
        function switchDrawerTab(tab) {
            if (tab === 'search') {
                els.viewSearch.classList.remove('hidden');
                els.viewPreset.classList.add('hidden');
                els.tabSearch.classList.add('active');
                els.tabPreset.classList.remove('active');
            } else {
                els.viewSearch.classList.add('hidden');
                els.viewPreset.classList.remove('hidden');
                els.tabSearch.classList.remove('active');
                els.tabPreset.classList.add('active');
                const model = document.querySelector('input[name="model_version"]:checked').value;
                renderPresets(model);
            }
        }
        
        function openPresets() {
            if (!els.sideDrawer.classList.contains('drawer-open')) toggleDrawer();
            switchDrawerTab('preset');
        }

        // é¢„è®¾é…ç½®
        const presetFiles = [
            { id: '1_v3', model: 'v3', name: 'æœªçŸ¥' },
            { id: '2_v3', model: 'v3', name: 'æœªçŸ¥' },
            { id: '1_v4.5', model: 'v4.5', name: 'é“ƒå…°' },
            { id: '2_v4.5', model: 'v4.5', name: 'æœªçŸ¥' }
        ];

        function renderPresets(model) {
            const activeClass = "bg-gray-800 text-white border-transparent shadow-md";
            const inactiveClass = "bg-white text-gray-500 border-gray-200 hover:bg-gray-50";
            
            if (model === 'v3') {
                els.btnPreV3.className = `px-4 py-1.5 rounded-full text-[10px] font-bold transition-all border ${activeClass}`;
                els.btnPreV4.className = `px-4 py-1.5 rounded-full text-[10px] font-bold transition-all border ${inactiveClass}`;
            } else {
                els.btnPreV3.className = `px-4 py-1.5 rounded-full text-[10px] font-bold transition-all border ${inactiveClass}`;
                els.btnPreV4.className = `px-4 py-1.5 rounded-full text-[10px] font-bold transition-all border ${activeClass}`;
            }

            els.presetGrid.innerHTML = '';
            const filtered = presetFiles.filter(p => p.model === model);
            
            if (filtered.length === 0) {
                els.presetGrid.innerHTML = '<div class="col-span-2 text-center text-xs text-gray-400">æ— é¢„è®¾</div>';
                return;
            }

            filtered.forEach(p => {
                const card = document.createElement('div');
                card.className = "preset-card group cursor-pointer flex flex-col gap-2";
                card.innerHTML = `
                    <div class="aspect-[2/3] w-full rounded-xl bg-gray-50 relative overflow-hidden group-hover:shadow-lg transition-all">
                        <img src="presets/${p.id}.png" class="w-full h-full object-cover">
                        <div class="absolute bottom-2 right-2 bg-white/90 rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                           <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
                        </div>
                    </div>
                    <span class="text-xs text-center text-gray-500 group-hover:text-gray-900">${p.name}</span>
                `;
                card.onclick = async () => {
                    const input = document.querySelector(`input[name="model_version"][value="${model}"]`);
                    if (!input.checked) { input.checked = true; updateModelUI(model); }
                    try {
                        const res = await fetch(`presets/${p.id}.txt`);
                        if(res.ok) {
                            els.prompt.value = (await res.text()).trim();
                            els.prompt.classList.add('bg-blue-50');
                            setTimeout(()=>els.prompt.classList.remove('bg-blue-50'), 500);
                            if(window.innerWidth < 768) toggleDrawer();
                        }
                    } catch(e){}
                };
                els.presetGrid.appendChild(card);
            });
        }

        // ç®¡ç†å‘˜é€»è¾‘
        function enterAdminToken() {
            const currentToken = localStorage.getItem('nai_admin_token');
            const token = prompt(currentToken ? "æ¸…ç©ºä»¥æ³¨é”€" : "è¾“å…¥ç®¡ç†å‘˜å¯†ç ");
            if (token !== null) {
                if (!token.trim()) localStorage.removeItem('nai_admin_token');
                else localStorage.setItem('nai_admin_token', token.trim());
                checkAdminStatus();
            }
        }
        function checkAdminStatus() {
            const token = localStorage.getItem('nai_admin_token');
            if (token) {
                els.adminLockBtn.innerHTML = '<i data-lucide="unlock" class="w-4 h-4 text-green-500"></i>';
                els.adminLockBtn.title = "ç®¡ç†å‘˜å·²ç™»å½•";
            } else {
                els.adminLockBtn.innerHTML = '<i data-lucide="lock" class="w-4 h-4 text-gray-300"></i>';
                els.adminLockBtn.title = "ç‚¹å‡»ç™»å½•ç®¡ç†å‘˜";
            }
            lucide.createIcons();
        }
        checkAdminStatus();

        // æœè¯é€»è¾‘
        let tagData = {};
        fetch('all_tags.txt').then(r=>r.json()).then(d=>tagData=d).catch(()=>{});
        
        els.tagSearchBtn.onclick = () => {
            const q = els.tagSearchInput.value.toLowerCase().trim();
            if(!q) return;
            const res = Object.entries(tagData).filter(([e,c])=>e.includes(q)||c.includes(q));
            els.tagResults.innerHTML = '';
            res.forEach(([en,cn]) => {
                const d = document.createElement('div');
                d.className = "p-3 hover:bg-gray-50 border-b cursor-pointer";
                d.innerHTML = `<div class="text-sm font-medium">${en}</div><div class="text-xs text-gray-400">${cn}</div>`;
                d.onclick = () => {
                    els.prompt.value += (els.prompt.value ? ', ' : '') + en;
                    els.prompt.classList.add('bg-blue-50');
                    setTimeout(()=>els.prompt.classList.remove('bg-blue-50'), 300);
                };
                els.tagResults.appendChild(d);
            });
        };
    </script>
</body>
</html>
