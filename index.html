<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NovelAI Opus Pure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { bg: '#0f172a', panel: '#1e293b', border: '#334155', text: '#e2e8f0' }
                    },
                    height: { 'screen-dvh': '100dvh' },
                    transitionProperty: { 'height': 'height, max-height, padding, transform, opacity, background-color' },
                    boxShadow: {
                        'line': '0 0 0 1px rgba(0,0,0,0.03), 0 1px 2px rgba(0,0,0,0.05)',
                        'float': '0 15px 30px -5px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0,0,0,0.02)'
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif;
            /* é™æ€çº¯å‡€æ¸å˜èƒŒæ™¯ */
            background: linear-gradient(to bottom, #ffffff, #f3f4f6);
            color: #374151;
            overscroll-behavior: none;
        }
        html.dark body {
            background: linear-gradient(to bottom, #0f172a, #111827);
            color: #cbd5e1;
        }

        .custom-scroll::-webkit-scrollbar { width: 0px; background: transparent; }

        /* è½»é‡åŒ–é¢æ¿ï¼šå‡å°‘æ¨¡ç³ŠåŠå¾„ï¼Œä¿ç•™çº¿æ¡ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            border-right: 1px solid #e5e7eb;
        }
        html.dark .glass-panel {
            background: rgba(30, 41, 59, 0.98);
            border-color: #334155;
        }

        /* ç§»åŠ¨ç«¯åº•éƒ¨æŠ½å±‰ */
        #mobileControls {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 80dvh; 
            z-index: 40;
            /* æ”¶èµ·ä½ç½®ï¼šåªéœ²å‡ºé¡¶éƒ¨æ ‡é¢˜æ  (çº¦64px) */
            transform: translateY(calc(100% - 64px)); 
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: transform;
            border-top: 1px solid #e5e7eb;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
        }
        html.dark #mobileControls { border-top-color: #334155; box-shadow: 0 -4px 20px rgba(0,0,0,0.2); }

        /* æ¡Œé¢ç«¯å¤ä½ */
        @media (min-width: 768px) {
            #mobileControls {
                position: relative;
                height: 100%;
                transform: none !important;
                z-index: 20;
                border-radius: 0;
                border-top: none;
                box-shadow: none;
            }
        }

        #mobileControls.expanded { transform: translateY(0); }

        #mobileBackdrop { transition: opacity 0.3s ease; }
        #mobileBackdrop.hidden-backdrop { opacity: 0; pointer-events: none; }

        /* æ‚¬æµ®æŒ‰é’® (FAB) - çº¯è‰²å—+é˜´å½±ï¼Œå»é™¤å¤æ‚æ¸å˜ */
        #floatingGenerateBtn {
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.2s;
            background-color: #111827;
            box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.2);
            z-index: 50;
        }
        html.dark #floatingGenerateBtn {
            background-color: #f8fafc;
            box-shadow: 0 8px 16px -4px rgba(255, 255, 255, 0.1);
        }
        #floatingGenerateBtn:active { transform: scale(0.95); }
        
        /* ä¾§è¾¹æ  */
        .drawer { transition: transform 0.3s ease-out; }
        .drawer-open { transform: translateX(0); }
        .drawer-closed { transform: translateX(-100%); }

        /* çº¯å‡€è¾“å…¥æ¡† */
        .art-input {
            transition: border-color 0.2s, background-color 0.2s;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
        }
        .art-input:focus {
            background-color: #fff;
            border-color: #9ca3af;
            outline: none;
        }
        html.dark .art-input {
            background-color: #1e293b;
            border-color: #334155;
            color: #e2e8f0;
        }
        html.dark .art-input:focus { background-color: #0f172a; border-color: #64748b; }

        /* æ¨¡å‹å¼€å…³æ»‘å— */
        .switch-bg {
            position: absolute; height: calc(100% - 8px); width: calc(50% - 4px);
            top: 4px; left: 4px; background: white; border-radius: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 0;
            border: 1px solid rgba(0,0,0,0.04);
        }
        html.dark .switch-bg { background: #334155; border-color: transparent; }
        #model-v4:checked ~ .switch-bg { transform: translateX(100%); }
        
        input[type="radio"]:checked + label { color: #111827; font-weight: 600; }
        html.dark input[type="radio"]:checked + label { color: #fff; }

        /* Tab åˆ‡æ¢ */
        .view-toggle {
            background: #f3f4f6; border: 1px solid #e5e7eb;
            border-radius: 99px; padding: 3px; display: flex; position: relative; width: 140px;
        }
        html.dark .view-toggle { background: #1e293b; border-color: #334155; }
        .view-toggle button {
            position: relative; z-index: 2; flex: 1; text-align: center;
            font-size: 11px; font-weight: 600; color: #6b7280; transition: color 0.2s; padding: 4px 0;
        }
        .view-toggle button.active { color: #111827; }
        html.dark .view-toggle button { color: #94a3b8; }
        html.dark .view-toggle button.active { color: #fff; }
        .view-toggle-bg {
            position: absolute; top: 3px; bottom: 3px; left: 3px; width: calc(50% - 3px);
            background: white; border-radius: 99px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 1;
        }
        html.dark .view-toggle-bg { background: #475569; }
        .view-toggle[data-state="history"] .view-toggle-bg { transform: translateX(100%); }

        .loader {
            width: 20px; height: 20px; border: 2px solid currentColor;
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; animation: rotation 0.8s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body class="text-gray-600 dark:text-gray-300 h-screen-dvh w-screen overflow-hidden flex flex-col md:flex-row transition-colors duration-300">

    <!-- ä¾§è¾¹æ ï¼šèµ„æºåº“ -->
    <div id="sideDrawer" class="absolute inset-y-0 left-0 w-80 bg-white dark:bg-slate-900 z-50 drawer drawer-closed flex flex-col border-r border-gray-100 dark:border-gray-800 shadow-2xl">
        <div class="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-800 shrink-0">
            <h2 class="font-medium text-lg text-gray-800 dark:text-gray-100 flex items-center gap-2 tracking-tight">
                <i data-lucide="library" class="w-5 h-5 text-gray-400"></i> èµ„æºåº“
            </h2>
            <button onclick="toggleDrawer()" class="p-2 hover:bg-gray-50 dark:hover:bg-slate-800 rounded-full text-gray-400 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="p-2 border-b border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-slate-900/50 shrink-0 flex gap-2">
            <button onclick="switchDrawerTab('search')" id="tab-search" class="flex-1 py-2 text-xs font-medium rounded-lg transition-all border shadow-sm text-gray-900 bg-white border-gray-200 dark:bg-slate-800 dark:border-gray-700 dark:text-gray-200">æœè¯</button>
            <button onclick="switchDrawerTab('preset')" id="tab-preset" class="flex-1 py-2 text-xs font-medium rounded-lg transition-all border border-transparent text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">é¢„è®¾</button>
        </div>
        
        <!-- æœç´¢ -->
        <div id="view-search" class="flex flex-col flex-1 overflow-hidden">
            <div class="p-4 border-b border-gray-100 dark:border-gray-800 shrink-0">
                <div class="flex gap-2 relative group">
                    <input type="text" id="tagSearchInput" placeholder="è¾“å…¥å…³é”®è¯..." class="art-input w-full px-4 py-2.5 rounded-xl text-sm outline-none">
                    <button id="tagSearchBtn" class="px-4 py-2 bg-gray-900 dark:bg-white text-white dark:text-gray-900 text-xs font-bold rounded-xl active:scale-95 transition-transform shadow-lg">GO</button>
                </div>
            </div>
            <div id="tagResults" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scroll"><div class="text-center mt-20 text-xs text-gray-400 font-light tracking-wide">è¾“å…¥ä¸­æ–‡/è‹±æ–‡å…³é”®è¯å¼€å§‹æ¢ç´¢</div></div>
        </div>
        
        <!-- é¢„è®¾ -->
        <div id="view-preset" class="flex flex-col flex-1 overflow-hidden hidden">
            <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-800 flex gap-2 justify-center shrink-0">
                <button onclick="renderPresets('v3')" id="btn-pre-v3" class="px-4 py-1.5 rounded-full text-[10px] font-bold border transition-all">V3</button>
                <button onclick="renderPresets('v4.5')" id="btn-pre-v4" class="px-4 py-1.5 rounded-full text-[10px] font-bold border transition-all">V4.5</button>
            </div>
            <div id="presetGrid" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 gap-3 content-start custom-scroll"></div>
        </div>
    </div>
    <div id="drawerOverlay" onclick="toggleDrawer()" class="fixed inset-0 bg-gray-900/10 backdrop-blur-[1px] z-40 hidden transition-opacity duration-300"></div>

    <!-- ä¸»ç•Œé¢ï¼šé¢„è§ˆä¸å›¾åº“ -->
    <div class="absolute inset-0 md:relative md:flex-1 md:order-2 flex flex-col overflow-hidden transition-colors z-0 bg-white/50 dark:bg-slate-900/50">
        
        <!-- é¡¶éƒ¨å·¥å…·æ  -->
        <div class="absolute top-0 left-0 right-0 h-16 flex items-center justify-between px-4 md:px-8 z-20 pointer-events-none">
            <div class="pointer-events-auto shadow-sm rounded-full bg-white/90 dark:bg-slate-800/90 backdrop-blur p-0.5 border border-gray-100 dark:border-gray-700/50">
                <div class="view-toggle" id="viewToggle" data-state="preview">
                    <div class="view-toggle-bg"></div>
                    <button onclick="switchRightView('preview')" id="viewBtnPreview" class="active">ç”»å¸ƒ</button>
                    <button onclick="switchRightView('history')" id="viewBtnHistory">å›¾åº“</button>
                </div>
            </div>
            
            <div class="pointer-events-auto flex gap-2">
                <button onclick="clearAllHistory()" id="clearBtn" class="hidden p-2 rounded-full bg-white/80 dark:bg-slate-800/80 border border-gray-100 dark:border-gray-700 text-red-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-slate-700 shadow-sm transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                <button onclick="downloadZip()" id="zipBtn" class="hidden p-2 rounded-full bg-white/80 dark:bg-slate-800/80 border border-gray-100 dark:border-gray-700 text-blue-500 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-slate-700 shadow-sm transition-all"><i data-lucide="archive" class="w-4 h-4"></i></button>
                <button onclick="downloadImage()" id="dlBtn" class="p-2 rounded-full bg-white/80 dark:bg-slate-800/80 border border-gray-100 dark:border-gray-700 text-gray-500 hover:text-gray-900 dark:hover:text-gray-200 shadow-sm transition-all opacity-50 cursor-not-allowed" disabled><i data-lucide="download" class="w-4 h-4"></i></button>
            </div>
        </div>

        <!-- çª—å£ 1: ç”»å¸ƒ -->
        <!-- åº•éƒ¨ padding ç•™è¶³ï¼Œé˜²æ­¢è¢« FAB é®æŒ¡ -->
        <div id="previewArea" class="flex-1 w-full h-full flex flex-col items-center justify-center p-4 pt-20 pb-24 md:p-10 relative overflow-hidden">
            <div id="placeholder" class="text-center transition-all duration-500 transform hover:scale-105 cursor-default">
                <div class="w-20 h-20 bg-white dark:bg-slate-800 rounded-[2rem] shadow-line flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="image" class="w-8 h-8 text-gray-300 dark:text-slate-600"></i>
                </div>
                <p class="text-xs font-medium text-gray-400 dark:text-slate-500 tracking-[0.2em] uppercase">Opus Pure</p>
                <!-- ç§»åŠ¨ç«¯æ¨¡å‹æŒ‡ç¤º -->
                <div id="modelBadge" class="md:hidden mt-3 text-[10px] font-bold text-gray-400 dark:text-slate-600 bg-white/50 dark:bg-slate-800/50 px-3 py-1 rounded-full border border-gray-100 dark:border-slate-700">V3</div>
            </div>

            <div class="relative w-full h-full flex items-center justify-center">
                <!-- .img-transition ç”¨äºå¹³æ»‘æ˜¾ç¤º -->
                <img id="resultImage" class="hidden max-w-full max-h-full object-contain shadow-2xl rounded-lg transition-opacity duration-500 opacity-0 transform scale-95">
            </div>
            
            <div id="imageActions" class="absolute bottom-28 md:bottom-8 flex gap-3 opacity-0 transition-all duration-300 pointer-events-none transform translate-y-4 z-10">
                <button onclick="useCurrentPrompt()" class="pointer-events-auto px-5 py-2.5 bg-white/90 dark:bg-slate-800/90 backdrop-blur-md text-xs font-semibold text-gray-700 dark:text-gray-200 rounded-full shadow-float border border-white/50 dark:border-slate-600 hover:scale-105 transition-all flex items-center gap-2"><i data-lucide="pen-tool" class="w-3 h-3"></i> æç¤ºè¯</button>
                <button onclick="deleteCurrentImage()" class="pointer-events-auto px-5 py-2.5 bg-white/90 dark:bg-slate-800/90 backdrop-blur-md text-xs font-semibold text-red-500 rounded-full shadow-float border border-white/50 dark:border-slate-600 hover:scale-105 transition-all flex items-center gap-2"><i data-lucide="trash" class="w-3 h-3"></i> åˆ é™¤</button>
            </div>
        </div>

        <!-- çª—å£ 2: å†å² -->
        <div id="historyArea" class="flex-1 hidden w-full h-full overflow-y-auto p-4 pt-20 pb-32 md:pb-10 custom-scroll">
            <div id="galleryGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 content-start"></div>
            <div id="emptyGallery" class="hidden h-full flex flex-col items-center justify-center text-gray-300 dark:text-slate-600">
                <i data-lucide="ghost" class="w-10 h-10 mb-3 opacity-50"></i>
                <span class="text-xs font-medium">ç©ºç©ºå¦‚ä¹Ÿ</span>
            </div>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯é®ç½©å±‚ -->
    <div id="mobileBackdrop" class="fixed inset-0 bg-gray-900/10 backdrop-blur-[1px] z-30 hidden md:hidden transition-opacity duration-300 opacity-0 pointer-events-none" onclick="toggleMobileControls(false)"></div>

    <!-- é¢æ¿ Aï¼šæ§åˆ¶å° (åº•éƒ¨æŠ½å±‰) -->
    <div id="mobileControls" class="collapsed md:relative md:h-full md:w-[400px] glass-panel flex flex-col z-40 shadow-[0_-10px_40px_-10px_rgba(0,0,0,0.05)] md:shadow-xl md:order-1 md:rounded-none border-t border-white/60 dark:border-slate-700/50">
        
        <!-- æŠŠæ‰‹ (ç‚¹å‡»å±•å¼€/æ”¶èµ·) -->
        <div class="md:hidden w-full flex flex-col items-center pt-3 pb-2 cursor-pointer touch-none" onclick="toggleMobileControls()">
            <div class="w-10 h-1 bg-gray-200 dark:bg-slate-600 rounded-full mb-2"></div>
            <div class="flex items-center justify-between w-full px-6 text-xs font-medium text-gray-500 dark:text-gray-400">
                <span class="flex items-center gap-1"><i data-lucide="sliders-horizontal" class="w-3 h-3"></i> å‚æ•°æ§åˆ¶å°</span>
                <span id="modelStatusMini" class="font-mono text-[10px] bg-gray-100 dark:bg-slate-800 px-2 py-0.5 rounded">V3</span>
            </div>
        </div>

        <!-- å®Œæ•´å¤´éƒ¨ -->
        <div class="hidden md:block px-6 py-5 border-b border-gray-100 dark:border-gray-800 shrink-0">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <button onclick="toggleDrawer()" class="p-2 -ml-2 hover:bg-gray-50 dark:hover:bg-slate-800 rounded-xl transition-all text-gray-400 hover:text-gray-800"><i data-lucide="menu" class="w-5 h-5"></i></button>
                    <h1 class="text-base font-bold text-gray-800 dark:text-gray-100 tracking-tight">Opus Art</h1>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-50 dark:hover:bg-slate-800 text-gray-400 transition-colors"><i data-lucide="moon" class="w-4 h-4 block dark:hidden"></i><i data-lucide="sun" class="w-4 h-4 hidden dark:block"></i></button>
                    <button onclick="enterAdminToken()" id="adminLockBtn" class="p-2 rounded-full hover:bg-gray-50 dark:hover:bg-slate-800 text-gray-400 transition-colors"><i data-lucide="lock" class="w-4 h-4"></i></button>
                </div>
            </div>
            <!-- æ¨¡å‹åˆ‡æ¢ -->
            <div class="relative bg-gray-100/50 dark:bg-slate-800/50 p-1 rounded-xl flex border border-gray-200/50 dark:border-gray-700/50" id="modelToggleContainer" data-model="v3">
                <div class="switch-bg absolute top-1 bottom-1 left-1 w-[calc(50%-4px)] bg-white dark:bg-slate-700 rounded-lg shadow-sm transition-transform duration-300 z-0"></div>
                <button onclick="setModel('v3')" class="flex-1 text-center py-2 text-xs font-semibold z-10 cursor-pointer text-gray-500 dark:text-gray-400 relative transition-colors">NAI V3</button>
                <button onclick="setModel('v4.5')" class="flex-1 text-center py-2 text-xs font-semibold z-10 cursor-pointer text-gray-500 dark:text-gray-400 relative flex items-center justify-center gap-1 transition-colors">V4.5 <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span></button>
                <input type="hidden" id="modelValue" value="v3">
            </div>
        </div>

        <!-- æ»šåŠ¨å‚æ•°åŒº -->
        <div class="flex-1 overflow-y-auto p-6 space-y-6 custom-scroll relative">
            <!-- ç§»åŠ¨ç«¯æ˜¾ç¤ºçš„äº®æš—åˆ‡æ¢ & é” (æ¡Œé¢ç«¯éšè—) -->
            <div class="md:hidden flex justify-between items-center px-1 pb-2">
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">è®¾ç½®</span>
                <div class="flex gap-2">
                    <button onclick="toggleTheme()" class="p-1.5 rounded-full bg-gray-100 dark:bg-slate-800 text-gray-500"><i data-lucide="moon" class="w-4 h-4 block dark:hidden"></i><i data-lucide="sun" class="w-4 h-4 hidden dark:block"></i></button>
                    <button onclick="enterAdminToken()" class="p-1.5 rounded-full bg-gray-100 dark:bg-slate-800 text-gray-500"><i data-lucide="lock" class="w-4 h-4"></i></button>
                </div>
            </div>
            
            <!-- ç§»åŠ¨ç«¯æ¨¡å‹åˆ‡æ¢ -->
            <div class="md:hidden relative bg-gray-100/50 dark:bg-slate-800/50 p-1 rounded-xl flex border border-gray-200/50 dark:border-gray-700/50 mb-4">
                <div class="switch-bg absolute top-1 bottom-1 left-1 w-[calc(50%-4px)] bg-white dark:bg-slate-700 rounded-lg shadow-sm transition-transform duration-300 z-0"></div>
                <button onclick="setModel('v3')" class="flex-1 text-center py-2 text-xs font-semibold z-10 cursor-pointer text-gray-500 dark:text-gray-400 relative transition-colors">NAI V3</button>
                <button onclick="setModel('v4.5')" class="flex-1 text-center py-2 text-xs font-semibold z-10 cursor-pointer text-gray-500 dark:text-gray-400 relative transition-colors">V4.5 <span class="w-1.5 h-1.5 rounded-full bg-blue-500 ml-1"></span></button>
            </div>

            <div class="space-y-2">
                <div class="flex justify-between items-center px-1">
                    <label class="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest">æ­£å‘æç¤ºè¯</label>
                    <button onclick="openPresets()" class="text-[10px] text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors flex items-center gap-1"><i data-lucide="layout-grid" class="w-3 h-3"></i> é¢„è®¾åº“</button>
                </div>
                <textarea id="prompt" rows="3" class="art-input w-full px-4 py-3 rounded-xl text-sm outline-none shadow-sm resize-none text-gray-700 dark:text-gray-200" placeholder="High quality, masterpiece..."></textarea>
            </div>
            
            <div class="space-y-2">
                <label class="text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest px-1">è´Ÿå‘æç¤ºè¯</label>
                <textarea id="negativePrompt" rows="2" class="art-input w-full px-4 py-3 rounded-xl text-xs outline-none shadow-sm resize-none text-gray-600 dark:text-gray-300">lowres, bad anatomy, bad hands, text, error</textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-gray-400 dark:text-gray-500 px-1">ç”»å¹…æ¯”ä¾‹</label>
                    <div class="relative">
                        <select id="resolution" class="art-input w-full px-4 py-3 rounded-xl text-xs font-medium outline-none shadow-sm appearance-none cursor-pointer text-gray-700 dark:text-gray-200">
                            <option value="832,1216">Portrait</option>
                            <option value="1216,832">Landscape</option>
                            <option value="1024,1024">Square</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-3 h-3 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-gray-400 dark:text-gray-500 px-1">é‡‡æ ·ç®—æ³•</label>
                    <div class="relative">
                        <select id="sampler" class="art-input w-full px-4 py-3 rounded-xl text-xs font-medium outline-none shadow-sm appearance-none cursor-pointer text-gray-700 dark:text-gray-200">
                            <option value="k_euler">Euler</option>
                            <option value="k_euler_ancestral">Euler A</option>
                            <option value="k_dpmpp_2m">DPM++ 2M</option>
                            <option value="k_dpmpp_sde">SDE</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-3 h-3 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>
            </div>

            <div class="pt-4 border-t border-gray-100 dark:border-gray-800 space-y-5 pb-20 md:pb-0">
                <div class="space-y-3">
                    <div class="flex justify-between text-xs px-1"><span class="text-gray-500">ç”Ÿæˆæ­¥æ•°</span><span id="stepsValue" class="font-mono font-bold text-gray-900 dark:text-gray-100">28</span></div>
                    <input type="range" id="steps" min="1" max="28" value="28" class="w-full h-1.5 bg-gray-200 dark:bg-slate-700 rounded-full appearance-none cursor-pointer">
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between text-xs px-1"><span class="text-gray-500">ç›¸å…³æ€§ (Scale)</span><span id="scaleValue" class="font-mono font-bold text-gray-900 dark:text-gray-100">5.0</span></div>
                    <input type="range" id="scale" min="1" max="20" value="5" step="0.5" class="w-full h-1.5 bg-gray-200 dark:bg-slate-700 rounded-full appearance-none cursor-pointer">
                </div>
            </div>
        </div>
        
        <!-- æ¡Œé¢ç«¯åº•éƒ¨æŒ‰é’® (ç§»åŠ¨ç«¯éšè—) -->
        <div class="hidden md:block p-6 border-t border-gray-100 dark:border-gray-800 bg-white/80 dark:bg-slate-900/80 backdrop-blur z-20">
            <button id="desktopGenerateBtn" class="w-full group flex items-center justify-center gap-2 py-4 px-4 bg-gray-900 dark:bg-white hover:bg-black dark:hover:bg-gray-100 text-white dark:text-gray-900 text-sm font-bold rounded-2xl transition-all shadow-xl hover:shadow-2xl hover:-translate-y-0.5 active:scale-[0.98]">
                <span id="deskBtnIcon"><i data-lucide="sparkles" class="w-4 h-4 text-yellow-300 dark:text-yellow-600"></i></span>
                <span class="loader hidden w-4 h-4 border-white/50 dark:border-gray-900/50"></span>
                <span id="deskBtnText">å…è´¹ç”Ÿæˆ</span>
            </button>
        </div>
    </div>

    <!-- ğŸ“± ç§»åŠ¨ç«¯æ‚¬æµ®ç”ŸæˆæŒ‰é’® (FAB) -->
    <button id="floatingGenerateBtn" class="md:hidden fixed bottom-6 right-6 w-16 h-16 rounded-2xl shadow-2xl flex items-center justify-center z-50 transition-all active:scale-90 border border-white/10 dark:border-white/5 text-white dark:text-gray-900" id="fabBtn">
        <i data-lucide="sparkles" class="w-7 h-7 text-yellow-300 dark:text-gray-900"></i>
    </button>

    <script>
        lucide.createIcons();
        
        // --- ç§»åŠ¨ç«¯æŠ½å±‰æ§åˆ¶ ---
        const mobileControls = document.getElementById('mobileControls');
        const mobileBackdrop = document.getElementById('mobileBackdrop');
        let isControlsExpanded = false;

        function toggleMobileControls(forceState) {
            if (window.innerWidth >= 768) return; 
            if (typeof forceState !== 'undefined') isControlsExpanded = forceState;
            else isControlsExpanded = !isControlsExpanded;

            if (isControlsExpanded) {
                mobileControls.classList.remove('collapsed');
                mobileControls.classList.add('expanded');
                mobileBackdrop.classList.remove('hidden-backdrop', 'opacity-0', 'pointer-events-none');
            } else {
                mobileControls.classList.remove('expanded');
                mobileControls.classList.add('collapsed');
                mobileBackdrop.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => mobileBackdrop.classList.add('hidden-backdrop'), 300);
            }
        }

        // --- æ¨¡å‹åˆ‡æ¢é€»è¾‘ ---
        function setModel(ver) {
            const inputs = document.querySelectorAll(`input[name="model_version"]`);
            const containers = document.querySelectorAll('#modelToggleContainer, .md\\:hidden #modelToggleContainer'); // é€‰æ‹©æ‰€æœ‰åˆ‡æ¢å™¨å®¹å™¨

            // æ›´æ–°éšè— Input
            document.getElementById('modelValue').value = ver;

            // æ›´æ–°æ»‘å—ä½ç½®
            document.querySelectorAll('.switch-bg').forEach(bg => {
                bg.style.transform = ver === 'v4.5' ? 'translateX(100%)' : 'translateX(0)';
            });

            // æ›´æ–° Badge
            const badge = document.getElementById('modelBadge');
            if(badge) badge.innerText = (ver === 'v4.5' ? 'V4.5' : 'V3') + ' MODE';
            
            // æ›´æ–°è¿·ä½ çŠ¶æ€
            const mini = document.getElementById('modelStatusMini');
            if(mini) mini.innerText = ver === 'v4.5' ? 'V4.5' : 'V3';
        }

        // --- è§†å›¾åˆ‡æ¢ ---
        let currentRightView = 'preview';
        const els = {
            // é›†ä¸­ DOM
            viewToggle: document.getElementById('viewToggle'),
            viewBtnPreview: document.getElementById('viewBtnPreview'),
            viewBtnHistory: document.getElementById('viewBtnHistory'),
            previewArea: document.getElementById('previewArea'),
            historyArea: document.getElementById('historyArea'),
            zipBtn: document.getElementById('zipBtn'),
            clearBtn: document.getElementById('clearBtn'),
            dlBtn: document.getElementById('dlBtn'),
            prompt: document.getElementById('prompt'),
            negative: document.getElementById('negativePrompt'),
            resolution: document.getElementById('resolution'),
            steps: document.getElementById('steps'),
            scale: document.getElementById('scale'),
            sampler: document.getElementById('sampler'),
            deskBtn: document.getElementById('desktopGenerateBtn'),
            floatBtn: document.getElementById('floatingGenerateBtn'),
            resultImg: document.getElementById('resultImage'),
            placeholder: document.getElementById('placeholder'),
            imageActions: document.getElementById('imageActions'),
            stepsVal: document.getElementById('stepsValue'),
            scaleVal: document.getElementById('scaleValue'),
            galleryGrid: document.getElementById('galleryGrid'),
            emptyGallery: document.getElementById('emptyGallery'),
            adminLockBtn: document.getElementById('adminLockBtn'),
            sideDrawer: document.getElementById('sideDrawer'),
            drawerOverlay: document.getElementById('drawerOverlay'),
            tabSearch: document.getElementById('tab-search'),
            tabPreset: document.getElementById('tab-preset'),
            viewSearch: document.getElementById('view-search'),
            viewPreset: document.getElementById('view-preset'),
            tagSearchInput: document.getElementById('tagSearchInput'),
            tagSearchBtn: document.getElementById('tagSearchBtn'),
            tagResults: document.getElementById('tagResults'),
            presetGrid: document.getElementById('presetGrid'),
            btnPreV3: document.getElementById('btn-pre-v3'),
            btnPreV4: document.getElementById('btn-pre-v4')
        };

        function switchRightView(view) {
            currentRightView = view;
            const toggleBg = els.viewToggle.querySelector('.view-toggle-bg');
            if(view === 'history') toggleBg.style.transform = 'translateX(100%)';
            else toggleBg.style.transform = 'translateX(0)';
            
            if (view === 'preview') {
                els.viewBtnPreview.classList.add('active');
                els.viewBtnHistory.classList.remove('active');
                els.previewArea.classList.remove('hidden');
                els.historyArea.classList.add('hidden');
                els.zipBtn.classList.add('hidden');
                els.clearBtn.classList.add('hidden');
                els.dlBtn.classList.remove('hidden');
            } else {
                els.viewBtnPreview.classList.remove('active');
                els.viewBtnHistory.classList.add('active');
                els.previewArea.classList.add('hidden');
                els.historyArea.classList.remove('hidden');
                loadGallery();
                els.zipBtn.classList.remove('hidden');
                els.clearBtn.classList.remove('hidden');
                els.dlBtn.classList.add('hidden');
            }
        }

        // --- ä¾§è¾¹æ  ---
        function toggleDrawer() {
            els.sideDrawer.classList.toggle('drawer-open');
            els.sideDrawer.classList.toggle('drawer-closed');
            els.drawerOverlay.classList.toggle('hidden');
        }

        function switchDrawerTab(tab) {
            const activeClass = "active flex-1 py-2 text-xs font-medium rounded-lg transition-all border shadow-sm text-gray-900 bg-white border-gray-200 dark:bg-slate-800 dark:border-gray-700 dark:text-gray-200";
            const inactiveClass = "flex-1 py-2 text-xs font-medium rounded-lg transition-all border border-transparent text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white";

            if (tab === 'search') {
                els.tabSearch.className = activeClass;
                els.tabPreset.className = inactiveClass;
                els.viewSearch.classList.remove('hidden');
                els.viewPreset.classList.add('hidden');
            } else {
                els.tabSearch.className = inactiveClass;
                els.tabPreset.className = activeClass;
                els.viewSearch.classList.add('hidden');
                els.viewPreset.classList.remove('hidden');
                renderPresets(document.getElementById('modelValue').value);
            }
        }

        function openPresets() {
            if (!els.sideDrawer.classList.contains('drawer-open')) toggleDrawer();
            switchDrawerTab('preset');
        }

        // --- æ ¸å¿ƒå˜é‡ ---
        let currentImageId = null;
        let currentImageData = null;

        // UI è”åŠ¨
        els.steps.addEventListener('input', e => els.stepsVal.textContent = e.target.value);
        els.scale.addEventListener('input', e => els.scaleVal.textContent = parseFloat(e.target.value).toFixed(1));

        // --- ç”Ÿæˆé€»è¾‘ ---
        function setLoading(loading) {
            // æ¡Œé¢
            els.deskBtn.disabled = loading;
            if (loading) {
                els.deskBtn.querySelector('#deskBtnIcon').classList.add('hidden');
                els.deskBtn.querySelector('.loader').classList.remove('hidden');
                els.deskBtn.querySelector('#deskBtnText').textContent = "ç”Ÿæˆä¸­...";
            } else {
                els.deskBtn.querySelector('#deskBtnIcon').classList.remove('hidden');
                els.deskBtn.querySelector('.loader').classList.add('hidden');
                els.deskBtn.querySelector('#deskBtnText').textContent = "å…è´¹ç”Ÿæˆ";
            }

            // æ‚¬æµ®
            els.floatBtn.disabled = loading;
            if (loading) {
                els.floatBtn.innerHTML = '<span class="loader border-white dark:border-gray-900"></span>';
                els.floatBtn.classList.add('scale-90');
            } else {
                els.floatBtn.innerHTML = '<i data-lucide="sparkles" class="w-7 h-7 text-yellow-400 dark:text-gray-900"></i>';
                els.floatBtn.classList.remove('scale-90');
                lucide.createIcons();
            }
            
            if (loading && !els.resultImg.classList.contains('hidden')) {
                els.resultImg.classList.add('opacity-50', 'blur-sm');
            } else if (!loading) {
                els.resultImg.classList.remove('opacity-50', 'blur-sm');
            }
        }

        async function doGenerate() {
            const promptText = els.prompt.value.trim();
            if (!promptText) { 
                els.prompt.focus(); 
                toggleMobileControls(true);
                return; 
            }
            const selectedVersion = document.getElementById('modelValue').value;
            const [w, h] = els.resolution.value.split(',').map(Number);
            const adminToken = localStorage.getItem('nai_admin_token') || "";
            
            if (currentRightView !== 'preview') switchRightView('preview');
            toggleMobileControls(false); 

            setLoading(true);
            
            try {
                const payload = {
                    version: selectedVersion,
                    prompt: promptText,
                    negative_prompt: els.negative.value.trim(),
                    width: w, height: h,
                    steps: parseInt(els.steps.value),
                    scale: parseFloat(els.scale.value),
                    sampler: els.sampler.value
                };
                const res = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-token': adminToken },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok || data.error) throw new Error(data.error || `Server Error: ${res.status}`);
                
                const tempImg = new Image();
                tempImg.src = data.image;
                tempImg.onload = () => {
                    els.resultImg.src = data.image;
                    els.placeholder.classList.add('hidden');
                    els.resultImg.classList.remove('hidden', 'scale-95', 'opacity-0');
                    els.dlBtn.disabled = false;
                    els.dlBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    setLoading(false);
                    saveToHistory(data.image, promptText, selectedVersion);
                };
            } catch (err) {
                console.error(err);
                setLoading(false);
                toggleMobileControls(true); 
                if (err.message.includes('429')) alert("âš ï¸ ä»Šæ—¥é¢åº¦å·²ç”¨å®Œ");
                else alert("ç”Ÿæˆå¤±è´¥: " + err.message);
            }
        }

        els.deskBtn.addEventListener('click', doGenerate);
        els.floatBtn.addEventListener('click', doGenerate);

        function downloadImage() {
            if (els.resultImg.src && !els.resultImg.classList.contains('hidden')) {
                const a = document.createElement('a');
                a.href = els.resultImg.src;
                a.download = `novelai-gen-${Date.now()}.png`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }
        }

        // --- IndexedDB ---
        const DB_NAME = 'nai_opus_db';
        const STORE_NAME = 'history';
        let db;
        const initDB = () => {
            const r = indexedDB.open(DB_NAME, 1);
            r.onupgradeneeded = e => { if(!e.target.result.objectStoreNames.contains(STORE_NAME)) e.target.result.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true }); };
            r.onsuccess = e => { db = e.target.result; loadGallery(); };
        };
        initDB();

        function saveToHistory(imgBase64, prompt, model) {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).add({ image: imgBase64, prompt, model, date: Date.now() }).onsuccess = (e) => {
                currentImageId = e.target.result;
                currentImageData = { image: imgBase64, prompt, model };
                showImageActions(true);
                loadGallery();
            };
        }
        function deleteCurrentImage() {
            if (!currentImageId || !db || !confirm("åˆ é™¤æ­¤å›¾ï¼Ÿ")) return;
            db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME).delete(currentImageId).onsuccess = () => {
                resetPreview(); loadGallery();
            };
        }
        window.clearAllHistory = function() {
            if (!db || !confirm("æ¸…ç©ºå†å²ï¼Ÿ")) return;
            db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME).clear().onsuccess = () => {
                loadGallery(); resetPreview();
            };
        };
        function loadGallery() {
            if (!db) return;
            db.transaction(STORE_NAME, 'readonly').objectStore(STORE_NAME).getAll().onsuccess = (e) => {
                renderGallery(e.target.result.reverse());
            };
        }
        function renderGallery(items) {
            els.galleryGrid.innerHTML = '';
            if (items.length === 0) {
                els.emptyGallery.classList.remove('hidden');
                els.zipBtn.classList.add('hidden');
                els.clearBtn.classList.add('hidden');
            } else {
                els.emptyGallery.classList.add('hidden');
                if (currentRightView === 'history') {
                    els.zipBtn.classList.remove('hidden');
                    els.clearBtn.classList.remove('hidden');
                }
                items.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'gallery-item aspect-square bg-gray-100 dark:bg-slate-800 rounded-lg overflow-hidden relative group border dark:border-slate-700 cursor-pointer shadow-sm';
                    el.innerHTML = `<img src="${item.image}" class="w-full h-full object-cover">`;
                    el.onclick = () => loadPreviewFromHistory(item);
                    els.galleryGrid.appendChild(el);
                });
            }
        }
        function loadPreviewFromHistory(item) {
            switchRightView('preview');
            els.resultImg.src = item.image;
            els.placeholder.classList.add('hidden');
            els.resultImg.classList.remove('hidden', 'scale-95', 'opacity-0');
            els.dlBtn.disabled = false;
            els.dlBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            currentImageId = item.id;
            currentImageData = item;
            showImageActions(true);
            toggleMobileControls(false);
        }
        function useCurrentPrompt() {
            if (!currentImageData) return;
            els.prompt.value = currentImageData.prompt;
            setModel(currentImageData.model || 'v3'); 
            els.prompt.classList.add('bg-blue-50', 'dark:bg-blue-900/30');
            setTimeout(() => els.prompt.classList.remove('bg-blue-50', 'dark:bg-blue-900/30'), 500);
            toggleMobileControls(true);
        }
        function resetPreview() {
            els.resultImg.src = '';
            els.resultImg.classList.add('hidden', 'scale-95', 'opacity-0');
            els.placeholder.classList.remove('hidden');
            els.dlBtn.disabled = true;
            els.dlBtn.classList.add('opacity-50', 'cursor-not-allowed');
            showImageActions(false);
            currentImageId = null;
            currentImageData = null;
        }
        function showImageActions(show) {
            if (show) els.imageActions.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-4');
            else els.imageActions.classList.add('opacity-0', 'pointer-events-none', 'translate-y-4');
        }
        window.downloadZip = function() {
            if (!db) return;
            db.transaction(STORE_NAME, 'readonly').objectStore(STORE_NAME).getAll().onsuccess = (e) => {
                const items = e.target.result;
                if (!items.length) return;
                const zip = new JSZip();
                const folder = zip.folder("novelai_gallery");
                items.forEach((item, idx) => folder.file(`image_${idx}.png`, item.image.split(',')[1], {base64: true}));
                zip.generateAsync({type:"blob"}).then(c => {
                    const a = document.createElement("a");
                    a.href = URL.createObjectURL(c);
                    a.download = `history_${Date.now()}.zip`;
                    a.click();
                });
            };
        };

        // --- é¢„è®¾é€»è¾‘ ---
        const presetFiles = [
            { id: '1_v3', model: 'v3', name: 'æœªçŸ¥' }, { id: '2_v3', model: 'v3', name: 'æœªçŸ¥' },
            { id: '1_v4.5', model: 'v4.5', name: 'é“ƒå…°' }, { id: '2_v4.5', model: 'v4.5', name: 'æœªçŸ¥' }
        ];
        function renderPresets(model) {
            const active = "px-3 py-1 rounded-full text-[10px] font-bold transition-all border bg-gray-900 text-white dark:bg-slate-100 dark:text-gray-900 border-transparent shadow-md";
            const inactive = "px-3 py-1 rounded-full text-[10px] font-bold transition-all border bg-white text-gray-500 border-gray-200 dark:bg-slate-800 dark:text-gray-400 dark:border-gray-700";
            
            if(model==='v3') { els.btnPreV3.className=active; els.btnPreV4.className=inactive; }
            else { els.btnPreV3.className=inactive; els.btnPreV4.className=active; }
            
            els.presetGrid.innerHTML = '';
            const filtered = presetFiles.filter(p => p.model === model);
            if(filtered.length === 0) { els.presetGrid.innerHTML = '<div class="col-span-2 text-center text-xs text-gray-400">æš‚æ— é¢„è®¾</div>'; return; }
            filtered.forEach(p => {
                const d = document.createElement('div');
                d.className = "group cursor-pointer flex flex-col gap-2";
                d.innerHTML = `<div class="aspect-[2/3] w-full rounded-lg bg-gray-100 dark:bg-slate-700 relative overflow-hidden group-hover:shadow-lg transition-all"><img src="presets/${p.id}.png" class="w-full h-full object-cover"></div><span class="text-xs text-center text-gray-500 dark:text-gray-400">${p.name}</span>`;
                d.onclick = async () => {
                    try {
                        const res = await fetch(`presets/${p.id}.txt`);
                        if(res.ok) {
                            els.prompt.value = (await res.text()).trim();
                            setModel(model);
                            toggleMobileControls(true);
                            if(window.innerWidth < 768) toggleDrawer();
                        }
                    } catch(e){}
                };
                els.presetGrid.appendChild(d);
            });
        }

        // --- æœè¯ ---
        let tagData = {};
        fetch('all_tags.txt').then(r=>r.json()).then(d=>tagData=d).catch(()=>{});
        els.tagSearchBtn.onclick = () => {
            const q = els.tagSearchInput.value.toLowerCase().trim();
            if(!q) return;
            const res = Object.entries(tagData).filter(([e,c])=>e.includes(q)||c.includes(q));
            els.tagResults.innerHTML = '';
            res.forEach(([en,cn]) => {
                const d = document.createElement('div');
                d.className = "p-3 hover:bg-gray-50 dark:hover:bg-slate-800 border-b border-gray-100 dark:border-gray-800 cursor-pointer transition-colors";
                d.innerHTML = `<div class="text-sm font-medium text-gray-800 dark:text-gray-200">${en}</div><div class="text-xs text-gray-400 dark:text-gray-500">${cn}</div>`;
                d.onclick = () => {
                    els.prompt.value += (els.prompt.value ? ', ' : '') + en;
                };
                els.tagResults.appendChild(d);
            });
        };

        // --- ä¸»é¢˜ä¸ç®¡ç†å‘˜ ---
        function initTheme() {
            if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else document.documentElement.classList.remove('dark');
        }
        initTheme();
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark'); localStorage.setItem('color-theme', 'light');
            } else {
                document.documentElement.classList.add('dark'); localStorage.setItem('color-theme', 'dark');
            }
        }
        function enterAdminToken() {
            const cur = localStorage.getItem('nai_admin_token');
            const t = prompt(cur ? "æ¸…ç©ºä»¥æ³¨é”€" : "è¾“å…¥ç®¡ç†å‘˜å¯†ç ");
            if (t !== null) {
                if (!t.trim()) localStorage.removeItem('nai_admin_token');
                else localStorage.setItem('nai_admin_token', t.trim());
                checkAdminStatus();
            }
        }
        function checkAdminStatus() {
            const t = localStorage.getItem('nai_admin_token');
            if (t) els.adminLockBtn.innerHTML = '<i data-lucide="unlock" class="w-4 h-4 text-green-500"></i>';
            else els.adminLockBtn.innerHTML = '<i data-lucide="lock" class="w-4 h-4 text-gray-300 dark:text-gray-500"></i>';
            lucide.createIcons();
        }
        checkAdminStatus();
    </script>
</body>
</html>
